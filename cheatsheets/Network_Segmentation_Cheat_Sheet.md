# Шпаргалка по сегментации сети

## Вступление

Сегментация сети является основой многоуровневой защиты современных сервисов. Сегментация замедляет работу злоумышленника, если он не может реализовать такие атаки, как:

- SQL-инъекции, см. [SQL Injection Prevention Cheat Sheet](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.md);
- компрометация рабочих станций сотрудников с повышенными привилегиями;
- компрометация другого сервера в периметре организации;
- компрометация целевой службы путем компрометации каталога LDAP, DNS-сервера и других корпоративных служб и сайтов, опубликованных в Интернете.

Основная цель этой шпаргалки - показать основы сегментации сети для эффективного противодействия атакам путем построения безопасной и максимально изолированной архитектуры сервисной сети.

Сегментация позволит избежать следующих ситуаций:

- выполнение произвольных команд на общедоступном веб-сервере (NginX, Apache, Internet Information Service) не позволяет злоумышленнику получить прямой доступ к базе данных;
- имея несанкционированный доступ к серверу базы данных, злоумышленник не может получить доступ к CnC через Интернет.

## Содержание

- Схематические обозначения;
- Трехуровневая сетевая архитектура;
- Межсервисное взаимодействие;
- Политика сетевой безопасности;
- Полезные ссылки.

## Схематические обозначения

Элементы, используемые в сетевых схемах:

![Схематические обозначения](https://raw.githubusercontent.com/OWASP/CheatSheetSeries/master/assets/Network_Segmentation_Cheat_Sheet_Schematic_symbols.drawio.png)

Пересечение границы прямоугольника означает пересечение брандмауэра:
![Трафик проходит через два брандмауэра](https://raw.githubusercontent.com/OWASP/CheatSheetSeries/master/assets/Network_Segmentation_Cheat_Sheet_firewall_1.drawio.png)

На изображении выше трафик проходит через два брандмауэра с именами FW1 и FW2

![Трафик проходит через один брандмауэр](https://raw.githubusercontent.com/OWASP/CheatSheetSeries/master/assets/Network_Segmentation_Cheat_Sheet_firewall_2.drawio.png)

На изображении выше трафик проходит через один брандмауэр, за которым находятся две виртуальные сети

Кроме того, схемы не содержат значков брандмауэра, чтобы не перегружать схемы

## Трехуровневая сетевая архитектура

По умолчанию разрабатываемые информационные системы должны состоять как минимум из трех компонентов (**зоны безопасности**).:

1. [FRONTEND](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Network_Segmentation_Cheat_Sheet.md#FRONTEND);
2. [MIDDLEWARE](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Network_Segmentation_Cheat_Sheet.md#MIDDLEWARE);
3. [BACKEND](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Network_Segmentation_Cheat_Sheet.md#BACKEND).

### FRONTEND

FRONTEND - Фронтэнд - это набор сегментов со следующими сетевыми элементами:

- балансировщик;
- межсетевой экран прикладного уровня;
- веб-сервер;
- веб-кэш.

![FRONTEND](https://raw.githubusercontent.com/OWASP/CheatSheetSeries/master/assets/Network_Segmentation_Cheat_Sheet_FRONTEND.drawio.png)

### MIDDLEWARE

MIDDLEWARE - набор сегментов для размещения следующих сетевых элементов:

- веб-приложения, реализующие логику работы информационной системы (обработка запросов от клиентов, других сервисов компании и внешних сервисов; выполнение запросов);
- сервисы авторизации;
- аналитические услуги;
- очереди сообщений;
- платформа потоковой обработки данных.

![MIDDLEWARE](https://raw.githubusercontent.com/OWASP/CheatSheetSeries/master/assets/Network_Segmentation_Cheat_Sheet_MIDDLEWARE.drawio.png)

### BACKEND

BACKEND - набор сегментов сети для размещения следующих сетевых элементов:

- База данных SQL;
- LDAP каталог (контроллер домена);
- хранение криптографических ключей;
- файловый сервер.

![BACKEND](https://raw.githubusercontent.com/OWASP/CheatSheetSeries/master/assets/Network_Segmentation_Cheat_Sheet_BACKEND.drawio.png)

### Пример архитектуры трехслойной сети

![BACKEND](https://raw.githubusercontent.com/OWASP/CheatSheetSeries/master/assets/Network_Segmentation_Cheat_Sheet_TIER_Example.drawio.png)
В следующем примере показана локальная сеть организации. Организация называется "Contoso".

Пограничный брандмауэр содержит 2 виртуальные сети **FRONTEND** зоны безопасности:

- _DMZ Inbound_ - сегмент для хостинга сервисов и приложений, доступных из Интернета, они должны быть защищены WAF;
- _DMZ Outgoing_ - сегмент для хостинг-сервисов, которые недоступны из Интернета, но имеют доступ к внешним сетям (брандмауэр не содержит никаких правил для разрешения трафика из внешних сетей).

Внутренний брандмауэр содержит 4 виртуальные сети:

- Зона безопасности **MIDDLEWARE** содержит только одну VLAN с именем _APPLICATIONS_ - сегмент, предназначенный для размещения приложений информационной системы, которые взаимодействуют друг с другом (межсервисное взаимодействие) и взаимодействуют с другими сервисами;
- **BACKEND** зона безопасности содержит:
    - _DATABASES_ - сегмент, предназначенный для разграничения различных баз данных автоматизированной системы;
    - _AD SERVICES_ - сегмент, предназначенный для размещения различных служб Active Directory, в примере показан только один сервер с контроллером домена Contoso.com;
    - _LOGS_ - сегмент, предназначенный для размещения серверов с журналами, на серверах централизованно хранятся журналы приложений автоматизированной системы.

## Межсервисное взаимодействие

Обычно несколько информационных систем компании взаимодействуют друг с другом. Важно определить политику брандмауэра для таких взаимодействий.
Базовые разрешенные взаимодействия обозначены зелеными стрелками на рисунке ниже:
![Межсервисное взаимодействие](https://raw.githubusercontent.com/OWASP/CheatSheetSeries/master/assets/Network_Segmentation_Cheat_Sheet_interservice.drawio.png)
На рисунке выше также показан разрешенный доступ из сегментов FRONTEND и MIDDLEWARE во внешние сети (например, в Интернет).

Из этого изображения следует:

1. Запрещен доступ между сегментами FRONTEND и MIDDLEWARE разных информационных систем;
2. Запрещен доступ из сегмента MIDDLEWARE к серверному сегменту другого сервиса (запрещен доступ к чужой базе данных в обход сервера приложений).

Запрещенные доступы обозначены красными стрелками на изображении ниже:
![Prohibited Interservice Communication](https://raw.githubusercontent.com/OWASP/CheatSheetSeries/master/assets/Network_Segmentation_Cheat_Sheet_interservice_deny.drawio.png)

### Множество приложений в одной сети

Если вы предпочитаете, чтобы в вашей организации было меньше сетей и в каждой из них размещалось больше приложений, допустимо разместить балансировщик нагрузки в этих сетях. Этот балансировщик будет балансировать трафик приложений в сети.
В этом случае необходимо будет открыть один порт для такой сети, и балансировка будет выполнена, например, на основе параметров HTTP-запроса.
Пример такой сегментации:
![Interservice Communication with balancing](https://raw.githubusercontent.com/OWASP/CheatSheetSeries/master/assets/Network_Segmentation_Cheat_Sheet_interservice_balancer.drawio.png)

Как вы можете видеть, в каждую сеть поступает только один входящий доступ, доступ открыт для балансировщика в сети. Однако в этом случае сегментация больше не работает, управление доступом между приложениями из разных сегментов сети осуществляется на 7-м уровне модели OSI с использованием балансировщика.

## Политика сетевой безопасности

Организация должна разработать "бумажную" политику, описывающую правила брандмауэра и базовый разрешенный доступ к сети.
Эта политика, по крайней мере, полезна:

- сетевым администраторам;
- представителям служб безопасности;
- ИТ-аудиторам;
- архитекторам информационных систем и программного обеспечения;
- разработчикам;
- ИТ-администраторам.

Удобно, когда политика описывается похожими изображениями. Информация представлена максимально сжато и просто.

### Примеры отдельных положений политики

Примеры из сетевой политики помогут коллегам быстро понять, какой доступ потенциально разрешен и может быть запрошен.

#### Разрешения для CI/CD

Политика сетевой безопасности может определять, например, основные разрешения, разрешенные для системы разработки программного обеспечения. Давайте рассмотрим пример того, как может выглядеть такая политика:
![CI-CD](https://raw.githubusercontent.com/OWASP/CheatSheetSeries/master/assets/Network_Segmentation_Cheat_Sheet_repo.drawio.png)

#### Безопасное ведение журнала

Важно, чтобы в случае компрометации какой-либо информационной системы ее логи впоследствии не были изменены злоумышленником. Для этого можно сделать следующее: скопировать логи на отдельный сервер, например, используя протокол syslog, который не позволяет злоумышленнику изменять логи, syslog позволяет только добавлять в логи новые события.
Политика сетевой безопасности для этого действия выглядит следующим образом:
![Logging](https://raw.githubusercontent.com/OWASP/CheatSheetSeries/master/assets/Network_Segmentation_Cheat_Sheet_logs.drawio.png)
В этом примере мы также говорим о журналах приложений, которые могут содержать события безопасности, а также потенциально важные события, которые могут указывать на атаку.

#### Разрешения для систем мониторинга

Предположим, компания использует Zabbix в качестве системы мониторинга ИТ. В этом случае политика может выглядеть следующим образом:
![Zabbix-Example](https://raw.githubusercontent.com/OWASP/CheatSheetSeries/master/assets/Network_Segmentation_Cheat_Sheet_Monitoring.drawio.png)

## Полезные ссылки

- Полная шпаргалка по сегментации сети от [sergiomarotco](https://github.com/sergiomarotco): [ссылка](https://github.com/sergiomarotco/Network-segmentation-cheat-sheet).
