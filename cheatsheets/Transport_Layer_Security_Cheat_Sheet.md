# Шпаргалка по безопасности транспортного уровня

## Вступление

В этом руководстве приведены рекомендации по внедрению защиты на транспортном уровне для приложений, использующих протокол Transport Layer Security (TLS). В основном речь идет о том, как использовать протокол TLS для защиты клиентов, подключающихся к веб-приложению по протоколу HTTPS, хотя большая часть этого руководства применима и к другим видам использования протокола TLS. При правильной реализации протокол TLS может обеспечить ряд преимуществ в плане безопасности:

- **Конфиденциальность**: Обеспечивает защиту от злоумышленников, считывающих содержимое трафика.
- **Целостность**: Обеспечивает защиту от изменения трафика, например, от повторной отправки злоумышленником запросов на сервер.
- **[Аутентификация](Authentication_Cheat_Sheet.md)**: Позволяет клиенту подтвердить, что он подключен к законному серверу. Обратите внимание, что идентификация клиента не проверяется, если не используются [клиентские сертификаты] (#client-certificates-and-mutual-tls).

### SSL vs TLS

Протокол Secure Socket Layer (SSL) был первоначальным протоколом, который использовался для обеспечения шифрования HTTP-трафика в форме HTTPS. Было выпущено две общедоступные версии SSL - версии 2 и 3. Обе они имеют серьезные криптографические недостатки и больше не должны использоваться.

По [различным причинам] (http://tim.dierks.org/2014/05/security-standards-and-name-changes-in.html) следующая версия протокола (фактически SSL 3.1) была названа Transport Layer Security (TLS) версии 1.0. Впоследствии были выпущены версии TLS 1.1, 1.2 и 1.3.

Термины "SSL", "SSL/TLS" и "TLS" часто используются как взаимозаменяемые, и во многих случаях "SSL" используется для обозначения более современного протокола TLS. В этой инструкции-шпаргалке будет использоваться термин "TLS", за исключением случаев, когда речь идет о устаревших протоколах.

## Конфигурация сервера

### Поддерживайте только надежные протоколы

Веб-приложения общего назначения должны по умолчанию использовать **TLS 1.3** (при необходимости поддерживать TLS 1.2), а все остальные протоколы должны быть отключены.

 В особых и необычных ситуациях, когда требуется веб-сервер для обслуживания устаревших клиентов, которые зависят от устаревших и незащищенных браузеров (например, Internet Explorer 10), активация TLS 1.0 может быть единственным вариантом. Однако к такому подходу следует подходить с осторожностью, и, как правило, он не рекомендуется из-за последствий для безопасности. Кроме того, [расширение "TLS_FALLBACK_SCSV"](https://tools.ietf.org/html/rfc7507) должно быть включено, чтобы предотвратить атаки с понижением версии для новых клиентов.

Обратите внимание, что PCI DSS [запрещает использование устаревших протоколов, таких как TLS 1.0](https://www.pcisecuritystandards.org/documents/Migrating-from-SSL-Early-TLS-Info-Supp-v1_1.pdf).

### Поддерживайте только надежные шифры

Существует большое количество различных шифров (или наборов шифров), поддерживаемых протоколом TLS, которые обеспечивают различные уровни безопасности. По возможности, следует использовать только шифры GCM. Однако, если необходимо поддерживать устаревшие клиенты, могут потребоваться другие шифры. Как минимум, всегда следует отключать следующие типы шифров:

- Null ciphers
- Anonymous ciphers
- EXPORT ciphers

Mozilla Foundation предоставляет [простой в использовании генератор защищенных конфигураций](https://ssl-config.mozilla.org/) для веб-серверов, серверов баз данных и почтовых серверов. Этот инструмент позволяет администраторам сайтов выбирать используемое программное обеспечение и получать файл конфигурации, оптимизированный для обеспечения баланса безопасности и совместимости с широким спектром версий браузеров и серверного программного обеспечения.

### Установите соответствующие группы Диффи-Хеллмана

Практика генерации параметров Диффи-Хеллмана в более ранних версиях протокола, чем TLS 1.3, для использования при обмене эфемерными ключами Диффи-Хеллмана (обозначаемыми строками "DHE" или "EDH" в названии набора шифров) имела практические проблемы. Например, клиент не имел права голоса при выборе параметров сервера, что означало, что он мог только безоговорочно принимать или отбрасывать их, а случайная генерация параметров часто приводила к атакам типа "отказ в обслуживании" (CVE-2022-40735, CVE-2002-20001).

TLS 1.3 ограничивает групповые параметры Диффи-Хеллмана известными группами с помощью расширения `supported_groups`. Доступные
Группами Диффи-Хеллмана являются `ffdhe2048`, `ffdhe3072`, `ffdhe4096`, `ffdhe6144`, `ffdhe8192`, как указано в [RFC7919].(https://www.rfc-editor.org/rfc/rfc7919 ).

По умолчанию openssl 3.0 поддерживает все вышеперечисленные группы. Чтобы изменить их, убедитесь, что в файле `openssl.cnf` присутствуют правильные параметры группы Диффи-Хеллмана. Например

```text
openssl_conf = openssl_init
[openssl_init]
ssl_conf = ssl_module
[ssl_module]
system_default = tls_system_default
[tls_system_default]
Groups = x25519:prime256v1:x448:ffdhe2048:ffdhe3072
```

Конфигурация apache будет выглядеть следующим образом

```text
SSLOpenSSLConfCmd Groups x25519:secp256r1:ffdhe3072
```

Та же самая группа в NGINX выглядела бы следующим образом

```text
ssl_ecdh_curve x25519:secp256r1:ffdhe3072;
```

Для TLS 1.2 или более ранних версий рекомендуется не устанавливать параметры Диффи-Хеллмана.

### Отключите сжатие

Сжатие TLS должно быть отключено для защиты от уязвимости (называемой [CRIME](https://threatpost.com/crime-attack-uses-compression-ratio-tls-requests-side-channel-hijack-secure-sessions-091312/77006/)), которая потенциально может позволить злоумышленнику восстановить конфиденциальную информацию, такую как файлы cookie сеанса.

### Исправьте криптографические библиотеки

Помимо уязвимостей в протоколах SSL и TLS, существует также большое количество исторических уязвимостей в библиотеках SSL и TLS, наиболее известной из которых является [Heartbleed](http://heartbleed.com). Поэтому важно убедиться, что эти библиотеки постоянно обновляются с помощью последних исправлений безопасности.

### Протестируйте конфигурацию сервера

После того, как сервер будет настроен, следует протестировать конфигурацию. Дополнительная информация о тестировании содержится в главе [Руководство по тестированию OWASP, посвященной SSL/TLS Testing](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography/01-Testing_for_Weak_Transport_Layer_Security).

Существует ряд онлайн-инструментов, которые можно использовать для быстрой проверки конфигурации сервера, в том числе:

- [SSL Labs Server Test](https://www.ssllabs.com/ssltest)
- [CryptCheck](https://cryptcheck.fr/)
- [Hardenize](https://www.hardenize.com/)
- [ImmuniWeb](https://www.immuniweb.com/ssl/)
- [Observatory by Mozilla](https://observatory.mozilla.org)
- [Scanigma](https://scanigma.com)
- [Stellastra](https://stellastra.com/tls-cipher-suite-check)
- [OWASP PurpleTeam](https://purpleteam-labs.com/) `cloud`

Кроме того, существует ряд автономных инструментов, которые можно использовать:

- [O-Saft - OWASP SSL advanced forensic tool](https://wiki.owasp.org/index.php/O-Saft)
- [CipherScan](https://github.com/mozilla/cipherscan)
- [CryptoLyzer](https://gitlab.com/coroner/cryptolyzer)
- [SSLScan - Fast SSL Scanner](https://github.com/rbsec/sslscan)
- [SSLyze](https://github.com/nabla-c0d3/sslyze)
- [testssl.sh - Testing any TLS/SSL encryption](https://testssl.sh)
- [tls-scan](https://github.com/prbinu/tls-scan)
- [OWASP PurpleTeam](https://purpleteam-labs.com/) `local`

## Сертификаты

### Используйте надежные ключи и защищайте их

Закрытый ключ, используемый для генерации ключа шифрования, должен быть достаточно надежным для обеспечения ожидаемого срока службы закрытого ключа и соответствующего сертификата. В настоящее время рекомендуется выбирать размер ключа не менее 2048 бит. Дополнительную информацию о сроках службы ключей и сопоставимых преимуществах можно найти [здесь] (http://www.keylength.com/en/compare/) и в [NIST SP 800-57](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-57pt1r5.pdf).

Закрытый ключ также должен быть защищен от несанкционированного доступа с помощью разрешений файловой системы и других технических и административных средств контроля.

### Используйте надежные криптографические алгоритмы хэширования

В сертификатах должен использоваться алгоритм хэширования SHA256, а не более старые алгоритмы MD5 и SHA-1. Они имеют ряд криптографических недостатков, и современные браузеры им не доверяют.

### Используйте правильные доменные имена

Доменное имя (или тема) сертификата должно совпадать с полным именем сервера, предоставляющего сертификат. Исторически это имя сохранялось в атрибуте сертификата `commonname` (CN). Однако современные версии Chrome игнорируют атрибут CN и требуют, чтобы полное доменное имя содержалось в атрибуте `subjectAlternativeName` (SAN). По соображениям совместимости сертификаты должны содержать основное полное доменное имя в CN и полный список полных доменных имен в SAN.

Кроме того, при создании сертификата следует учитывать следующее:

- Подумайте, следует ли также включать поддомен "www".
- Не включайте имена хостов, не соответствующие требованиям.
- Не включайте IP-адреса.
- Не включайте внутренние доменные имена во внешние сертификаты.
    - Если сервер доступен как с использованием внутреннего, так и с использованием внешнего полного доменного имени, настройте для него несколько сертификатов.

### Внимательно относитесь к использованию групповых сертификатов

Групповые сертификаты могут быть удобными, однако они нарушают [принцип наименьших привилегий] (https://wiki.owasp.org/index.php/Least_privilege), поскольку один сертификат действителен для всех поддоменов домена (например, *.example.org). Если несколько систем используют общий сертификат wildcard, вероятность того, что закрытый ключ для сертификата будет скомпрометирован, возрастает, поскольку ключ может присутствовать в нескольких системах. Кроме того, ценность этого ключа значительно возрастает, что делает его более привлекательной целью для злоумышленников.

Вопросы, связанные с использованием групповых сертификатов, являются сложными, и в Интернете есть [различные](https://blog.sean-wright.com/wildcard-certs-not-quite-the-star/) другие [обсуждения](https://gist.github.com/joepie91/7e5cad8c0726fd6a5e90360a754fc568) по ним.

При оценке рисков, связанных с использованием подстановочных сертификатов, следует учитывать следующие области:

- Используйте подстановочные сертификаты только в тех случаях, когда в этом действительно есть необходимость, а не для удобства.
    - Рассмотрите возможность использования [ACME](https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment), чтобы вместо этого позволить системам автоматически запрашивать и обновлять свои собственные сертификаты.
- Никогда не используйте групповые сертификаты для систем с разными уровнями доверия.
    - Два VPN-шлюза могут использовать общий wildcard сертификат.
    - Несколько экземпляров веб-приложения могут совместно использовать сертификат.
    - VPN-шлюз и общедоступный веб-сервер **не должны** совместно использовать групповой сертификат.
    - Общедоступный веб-сервер и внутренний сервер **не должны** совместно использовать групповой сертификат.
- Рассмотрите возможность использования обратного прокси-сервера, который выполняет завершение работы по протоколу TLS, чтобы закрытый ключ с подстановочным знаком присутствовал только в одной системе.
- Следует вести список всех систем, совместно использующих сертификат, чтобы все они могли обновляться в случае истечения срока действия сертификата или его компрометации.
- Ограничьте область действия группового сертификата, выдав его для поддомена (например, `*.foo.example.org`) или для отдельного домена.

### Используйте соответствующий центр сертификации для базы пользователей приложения

Чтобы пользователи могли доверять сертификатам, они должны быть подписаны надежным центром сертификации (CA). Для приложений, работающих с Интернетом, это должен быть один из хорошо известных центров сертификации, которым автоматически доверяют операционные системы и браузеры.

Центр сертификации [LetsEncrypt](https://letsencrypt.org) предоставляет бесплатные SSL-сертификаты, подтвержденные доменом, которым доверяют все основные браузеры. Поэтому подумайте, есть ли какие-либо преимущества в приобретении сертификата у центра сертификации.

Для внутренних приложений можно использовать внутренний центр сертификации. Это означает, что полное доменное имя сертификата не будет доступно (ни внешнему центру сертификации, ни публично в списках прозрачности сертификатов). Однако сертификату будут доверять только те пользователи, которые импортировали внутренний сертификат центра сертификации, который использовался для их подписи, и которым они доверяют.

### Используйте записи CAA, чтобы ограничить, какие центры сертификации могут выдавать сертификаты

Записи DNS центра сертификации (CAA) могут использоваться для определения того, какому классу разрешено выдавать сертификаты для домена. Записи содержат список центров сертификации, и любой центр сертификации, не включенный в этот список, должен отказать в выдаче сертификата для домена. Это может помочь предотвратить получение злоумышленником несанкционированных сертификатов для домена через центр сертификации с низкой репутацией. Если он применяется ко всем поддоменам, он также может быть полезен с административной точки зрения, ограничивая доступ администраторов центров сертификации или разработчиков к ним и предотвращая получение ими несанкционированных групповых сертификатов.

### Учитывайте тип проверки сертификата

Сертификаты могут быть проверены по-разному. Проверка - это процесс, который Центр сертификации (CA) использует, чтобы убедиться, что вам разрешено иметь сертификат. Это авторизация. Форум [CA/Browser Forum](https://cabforum.org/working-groups/server/baseline-requirements/documents/) - это организация, объединяющая центры сертификации и поставщиков браузеров, а также других лиц, заинтересованных в веб-безопасности. Они устанавливают правила, которым должны следовать центры сертификации в зависимости от типа проверки. Базовая проверка называется проверкой домена (DV). Все общедоступные сертификаты должны быть подтверждены доменом. Этот процесс предполагает практическое подтверждение контроля над именем или конечной точкой, запрошенными в сертификате. Обычно это включает запрос и ответ в DNS, на официальный адрес электронной почты или на конечную точку, которая получит сертификат.

Сертификаты, подтвержденные организацией (OV), содержат информацию об организации заявителя в теме сертификата. Например, C = Великобритания, ST = Манчестер, **O = Section Limited**, CN = sectigo.com. Процесс получения сертификата OV требует официального контакта с запрашивающей компанией с помощью метода, который доказывает центру сертификации, что они действительно обращаются к нужной компании.

Сертификаты расширенной валидации (EV) обеспечивают еще более высокий уровень проверки, а также все проверки DV и OV. Это можно рассматривать как разницу между "Этот сайт действительно принадлежит Example Company Inc." и "Этот домен действительно принадлежит example.org". [Последние расширенные рекомендации по валидации](https://cabforum.org/working-groups/server/extended-validation/guidelines/)

Исторически они отображались в браузере по-разному, часто с указанием названия компании или зеленого значка или фона в адресной строке. Однако с 2019 года ни один крупный браузер не отображает статус EV подобным образом, поскольку они не верят, что сертификаты EV обеспечивают какую-либо дополнительную защиту. ([Chromium](https://groups.google.com/a/chromium.org/forum/m/#!msg/security-dev/h1bTcoTpfeI/jUTk1z7VAAAJ ), охватывающий Chrome, Edge, Brave и Opera. [Firefox](https://groups.google.com/forum/m/?fromgroups&hl=en#!тема/firefox-dev/6wAg_PpnlY4) [Safari](https://cabforum.org/2018/06/06/minutes-of-the-f2f-44-meeting-in-london-england-6-7-june-2018/#apple-root-program-update))

Поскольку все браузеры и стеки TLS не знают о различиях между сертификатами DV, OV и EV, с точки зрения безопасности они практически одинаковы. Злоумышленнику достаточно достичь уровня практического контроля над доменом, чтобы получить поддельный сертификат.  Дополнительные усилия злоумышленника по получению сертификата OV или EV никоим образом не увеличивают масштаб инцидента. На самом деле, эти действия, скорее всего, будут означать обнаружение. Дополнительные трудности с получением сертификатов OV и EV могут создать угрозу доступности, и их использование следует пересмотреть с учетом этого.

## Приложение

### Используйте TLS Для Всех Страниц

TLS следует использовать для всех страниц, а не только для тех, которые считаются конфиденциальными, таких как страница входа в систему. Если есть какие-либо страницы, которые не поддерживают принудительное использование TLS, это может дать злоумышленнику возможность перехватить конфиденциальную информацию, такую как токены сеанса, или внедрить вредоносный JavaScript в ответы для проведения других атак против пользователя.

Для общедоступных приложений может оказаться целесообразным, чтобы веб-сервер прослушивал незашифрованные HTTP-соединения через порт 80, а затем немедленно перенаправлял их с помощью постоянной переадресации (HTTP 301), чтобы обеспечить лучший опыт для пользователей, которые вручную вводят доменное имя. Затем это должно быть поддержано заголовком [HTTP Strict Transport Security (HSTS)](#use-http-strict-transport-security), чтобы предотвратить доступ к сайту через HTTP в будущем.

Конечные точки, работающие только с API, должны полностью отключать HTTP и поддерживать только зашифрованные соединения. Если это невозможно, конечные точки API должны отклонять запросы, отправленные по незашифрованным HTTP-соединениям, а не перенаправлять их.

### Не смешивайте TLS- и не-TLS-контент

Страница, доступная по протоколу TLS, не должна содержать никаких ресурсов (таких как файлы JavaScript или CSS), которые загружаются по незашифрованному протоколу HTTP. Эти незашифрованные ресурсы могут позволить злоумышленнику перехватить сеансовые файлы cookie или внедрить вредоносный код на страницу. Современные браузеры также блокируют попытки загрузки активного контента по незашифрованному протоколу HTTP на защищенные страницы.

### Используйте флаг "Secure" для Cookie 

Все файлы cookie должны быть помечены атрибутом "[Secure](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Secure_and_HttpOnly_cookies)", который предписывает браузеру отправлять их только по зашифрованным HTTPS-соединениям, чтобы предотвратить их перехват по незашифрованному HTTP-соединению. Это важно, даже если веб-сайт не прослушивает HTTP (порт 80), поскольку злоумышленник, выполняющий атаку active man in the middle, может предоставить пользователю поддельный веб-сервер на порту 80, чтобы украсть его cookie.

### Предотвращение кэширования конфиденциальных данных

Хотя протокол TLS обеспечивает защиту данных во время их передачи, он не обеспечивает никакой защиты данных после того, как они попали в запрашивающую систему. Таким образом, эта информация может храниться в кэше браузера пользователя или любыми перехватывающими прокси-серверами, которые настроены для выполнения расшифровки TLS.

Если в ответах возвращаются конфиденциальные данные, следует использовать HTTP-заголовки, чтобы дать указание браузеру и любым прокси-серверам не кэшировать информацию, чтобы предотвратить ее сохранение или возврат другим пользователям. Этого можно достичь, установив в ответе следующие HTTP-заголовки:

```text
Cache-Control: no-cache, no-store, must-revalidate
Pragma: no-cache
Expires: 0
```

### Используйте HTTP Strict Transport Security

HTTP Strict Transport Security (HSTS) предписывает браузеру пользователя всегда запрашивать сайт по протоколу HTTPS, а также не позволяет пользователю обходить предупреждения сертификата. Дополнительную информацию о внедрении HSTS смотрите в [Руководстве по строгой транспортной безопасности HTTP Strict Transport Security](HTTP_Strict_Transport_Security_Cheat_Sheet.md).

### Клиентские сертификаты и взаимные TLS

В типичной конфигурации TLS сертификат на сервере позволяет клиенту проверить подлинность сервера и обеспечивает зашифрованное соединение между ними. Однако у этого подхода есть два основных недостатка:

- На сервере отсутствует механизм проверки личности клиента.
- Злоумышленник, получив действительный сертификат для домена, может перехватить соединение. Этот перехват часто используется предприятиями для проверки трафика TLS путем установки сертификата доверенного центра сертификации в своих клиентских системах.

Клиентские сертификаты, являющиеся основой mutual TLS (mTLS), решают эти проблемы. В mTLS клиент и сервер аутентифицируют друг друга с помощью TLS. Клиент подтверждает свою личность серверу с помощью своего собственного сертификата. Это не только обеспечивает надежную аутентификацию клиента, но и предотвращает расшифровку трафика TLS промежуточной стороной, даже если у нее есть сертификат доверенного центра сертификации в клиентской системе.

Проблемы и соображения

Клиентские сертификаты редко используются в общедоступных системах из-за ряда проблем:

- Выдача клиентских сертификатов и управление ими сопряжены со значительными административными затратами.
- Пользователям, не обладающим техническими знаниями, может быть сложно установить клиентские сертификаты.
- Методы расшифровки TLS в организациях могут привести к сбою проверки подлинности клиентских сертификатов, ключевого компонента mTLS.

Несмотря на эти проблемы, клиентские сертификаты и tls следует использовать для создания высокопроизводительных приложений или API-интерфейсов, особенно там, где пользователи технически продвинуты или являются частью одной организации.

### Закрепление открытого ключа

Закрепление открытого ключа может быть использовано для обеспечения гарантии того, что сертификат сервера не только действителен и является надежным, но и соответствует сертификату, ожидаемому для сервера. Это обеспечивает защиту от злоумышленника, который может получить действительный сертификат, воспользовавшись уязвимостью в процессе проверки, скомпрометировав доверенный центр сертификации или получив административный доступ к клиенту.

Привязка открытого ключа была добавлена в браузеры в соответствии со стандартом HTTP Public Key Pinning (HPKP). Однако из-за ряда проблем она впоследствии была признана устаревшей и больше не рекомендуется и [не поддерживается современными браузерами](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Public-Key-Pins).

Однако закрепление открытого ключа по-прежнему может обеспечить преимущества в плане безопасности для мобильных приложений, "полных" клиентов и взаимодействия между серверами. Более подробно это обсуждается в [Инструкции по закреплению](Pinning_Cheat_Sheet.md).

## Статьи по теме

- OWASP - [Testing for Weak TLS](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography/01-Testing_for_Weak_Transport_Layer_Security)
- OWASP - [Application Security Verification Standard (ASVS) - Communication Security Verification Requirements (V9)](https://github.com/OWASP/ASVS/blob/v4.0.1/4.0/en/0x17-V9-Communications.md)
- Mozilla - [Mozilla Recommended Configurations](https://wiki.mozilla.org/Security/Server_Side_TLS#Recommended_configurations)
- NIST - [SP 800-52 Rev. 2 Guidelines for the Selection, Configuration, and Use of Transport Layer Security (TLS) Implementations](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-52r2.pdf)
- NIST - [NIST SP 800-57 Recommendation for Key Management, Revision 5](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-57pt1r5.pdf)
- NIST - [SP 800-95 Guide to Secure Web Services](https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-95.pdf)
- IETF - [RFC 5280 Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile](https://tools.ietf.org/html/rfc5280)
- IETF - [RFC 2246 The Transport Layer Security (TLS) Protocol Version 1.0 (JAN 1999)](https://tools.ietf.org/html/rfc2246)
- IETF - [RFC 4346 The Transport Layer Security (TLS) Protocol Version 1.1 (APR 2006)](https://tools.ietf.org/html/rfc4346)
- IETF - [RFC 5246 The Transport Layer Security (TLS) Protocol Version 1.2 (AUG 2008)](https://tools.ietf.org/html/rfc5246)
- Bettercrypto - [Applied Crypto Hardening: HOW TO for secure crypto settings of the most common services)](https://bettercrypto.org)
