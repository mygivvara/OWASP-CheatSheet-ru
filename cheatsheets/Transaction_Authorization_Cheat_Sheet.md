# Шпаргалка по авторизации транзакций

## Цель и аудитория

В этом руководстве-шпаргалке рассказывается о том, как разработчики могут обеспечить безопасность авторизации транзакций и предотвратить их обход. Эти рекомендации предназначены для:

- **Банки** - которые должны разработать функциональные и нефункциональные требования для авторизации транзакций.
- **Разработчики** – которым необходимо устранить уязвимости при авторизации транзакций.
- **Пентестеры** – которые должны определить, безопасна ли авторизация транзакций.

## Вступление

Как правило, мобильные и онлайн-приложения требуют от пользователей предоставления второго фактора, чтобы система могла проверить, имеют ли они право на выполнение конфиденциальной операции (например, авторизацию банковского перевода). В этом документе мы говорим, что эти действия являются "авторизацией транзакции".

Авторизация транзакций часто используется в финансовых системах, но необходимость в безопасности транзакций привела к внедрению авторизации в Интернете.  Например, электронное письмо, позволяющее разблокировать учетную запись пользователя путем предоставления секретного кода или ссылки с токеном, содержит авторизацию транзакции. Авторизация транзакции может быть реализована с помощью таких методов, как:

- Карта, на которой указан номер авторизации транзакции
- Токен одноразового пароля (OTP), основанный на времени, например [OATH TOTP (Одноразовый пароль, основанный на времени)](https://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm)
- OTP, отправленный по SMS или предоставленный по телефону
- Цифровая подпись, предоставляемая смарт-картой или смартфоном
- Токен запроса-ответа, включая устройства для считывания неподключенных карт или решения, которые сканируют данные транзакции с экрана компьютера пользователя

Некоторые из этих форм авторизации транзакций могут быть реализованы с помощью физического устройства или мобильного приложения.

## 1. Функциональные рекомендации

### 1.1 Метод авторизации транзакции должен позволять пользователю идентифицировать и подтверждать важные данные транзакции

Поскольку разработчики не могут предполагать, что компьютер пользователя защищен, внешний компонент авторизации должен был бы проверять данные для обычной транзакции.

Когда разработчик создает компоненты для авторизации транзакций, он должен использовать принцип "Что вы видите, то и подписываете". Метод авторизации должен позволять пользователю идентифицировать и подтверждать данные, которые важны для данной транзакции. Например, в случае банковского перевода пользователь должен иметь возможность идентифицировать целевой счет и сумму.

Поскольку разработчики определяют, какие данные о транзакциях являются значимыми, их решения должны основываться на:

- Реальных рисках
- Технических возможностях и ограничениях выбранного метода авторизации
- Положительном опыте пользователей

Например, если в SMS-сообщении подтверждаются важные данные о транзакции, разработчик может ответить, вернув пользователю целевую учетную запись, сумму и тип перевода. Однако для неподключенного пользователя [CAP reader] (https://en.wikipedia.org/wiki/Chip_Authentication_Program) неудобно требовать от пользователей ввода этих данных. В таких случаях разработчику, вероятно, следует вернуть минимальное количество важных данных о транзакции (например, частичный номер целевого счета и сумму) для подтверждения.

Как правило, пользователь должен проверить все важные данные транзакции в рамках процесса авторизации транзакции. Если в процессе транзакции пользователю требуется ввести данные транзакции на внешнее устройство, пользователю должно быть предложено подтвердить конкретное значение транзакции (например, номер целевого счета). Отсутствием значимого запроса можно легко злоупотребить с помощью методов социальной инженерии и вредоносных программ, как описано ниже в разделе 1.4. Кроме того, более подробное обсуждение проблем перегрузки входных данных приведено [здесь].(http://www.cl.cam.ac.uk /~sjm217/papers/fc09optimized.pdf).

### 1.2 Изменение токена авторизации должно быть авторизовано с использованием текущего токена авторизации

Если пользователь может использовать интерфейс приложения для изменения токена авторизации, он должен иметь возможность авторизовать операцию, используя свои текущие учетные данные для авторизации (как в случае с [процедурой смены пароля ](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/04-Authentication_Testing/09-Testing_for_Weak_Password_Change_or_Reset_Functionalities.html)). Например: когда пользователь меняет номер телефона для использования SMS-кодов, на текущий номер телефона должен быть отправлен SMS-код авторизации.

### 1.3 Изменение метода авторизации должно быть авторизовано с использованием текущего метода авторизации

Некоторые приложения позволяют пользователю выбирать способ авторизации своих транзакций. В таких случаях разработчик должен убедиться, что приложение может подтвердить метод авторизации пользователя, чтобы предотвратить изменение метода авторизации пользователя вредоносным ПО на наиболее уязвимый. Кроме того, приложение должно информировать пользователя о любых потенциальных опасностях, связанных с его методом авторизации.

### 1.4 Пользователи должны иметь возможность легко отличать процесс аутентификации от процесса авторизации транзакции

Поскольку разработчикам необходимо предотвратить авторизацию пользователями мошеннических операций, их приложения не должны требовать от пользователя выполнения одних и тех же действий для аутентификации и авторизации транзакций. Рассмотрим следующий пример:

1. Приложение использует один и тот же метод для аутентификации пользователя и авторизации транзакции (т.е. с помощью токена OTP).
2. Вредоносная программа может использовать атаку "человек посередине (mitm)", чтобы выдать пользователю ложное сообщение об ошибке при вводе учетных данных в приложение, что может заставить пользователя повторить процедуру аутентификации. Первые учетные данные будут использоваться вредоносной программой для аутентификации, а вторые - для авторизации мошеннической транзакции. При использовании этого сценария можно злоупотреблять даже схемами "запрос-ответ", поскольку вредоносная программа может представить запрос, взятый из мошеннической транзакции, и обманом заставить пользователя предоставить ответ. Такой сценарий атаки широко используется в [вредоносных атаках на электронные банковские устройства](http://securityintelligence.com/back-basics-malware-authors-downgrade-tactics-stay-radar/#.VX_qI_krLDc).

Чтобы остановить такие атаки, разработчики могут убедиться, что действия по аутентификации отличаются от авторизации транзакций с помощью:

- Использование различных методов аутентификации и авторизации
- Использование различных действий во внешнем компоненте безопасности (например, использование другого режима работы в CAP-ридере)
- Предоставление пользователю четкого сообщения о том, что он "подписывает" (принцип "Что вы видите, то и подписываете").

Методы социальной инженерии [могут использоваться, несмотря на методы аутентификации и авторизации операций] (http://securityintelligence.com/tatanga-attack-exposes-chiptan-weaknesses/#.VZAy9PkrLDc) но приложение не должно облегчать такие сценарии атаки.

### 1.5 Каждая транзакция должна быть авторизована с использованием уникальных учетных данных для авторизации

Если приложения запрашивают учетные данные для авторизации транзакции только один раз (например, статический пароль, код, отправленный по SMS, или ответный токен), пользователь может авторизовать любую транзакцию в течение всего сеанса или повторно использовать те же учетные данные, когда ему нужно авторизовать транзакцию. В этом случае злоумышленники могут использовать вредоносное ПО для перехвата учетных данных и использования их для авторизации любой транзакции без ведома пользователя.

## 2. Нефункциональные руководящие принципы

### 2.1 Авторизация должна быть выполнена и принудительно применена на стороне сервера

Как и [все другие элементы управления безопасностью] (https://cwe.mitre.org/data/definitions/602.html), авторизация транзакций должна осуществляться на стороне сервера. Никогда не должно быть возможности повлиять на результат авторизации путем изменения данных, передаваемых от клиента к серверу, путем:

- Изменение параметров, содержащих данные транзакции
- Добавление/удаление параметров, которые отключают проверку авторизации
- Возникновение ошибки

Чтобы гарантировать, что управление данными осуществляется только на стороне сервера, следует применять рекомендации по программированию безопасности, такие как:

- [По умолчанию запрещено](https://wiki.owasp.org/index.php/Positive_security_model)
- Отказ от функций отладки в рабочем коде

Следует рассмотреть другие меры предосторожности для предотвращения несанкционированного доступа, такие как шифрование данных для обеспечения конфиденциальности и целостности, а затем расшифровка и проверка данных на стороне сервера.

### 2.2 Метод авторизации должен быть реализован на стороне сервера

Если пользователю доступно несколько методов авторизации транзакций, серверная сторона должна убедиться, что транзакция выполняется с использованием выбранного пользователем метода авторизации или метода авторизации, предусмотренного политиками приложения. В противном случае вредоносное ПО может понизить уровень метода авторизации даже до наименее безопасного метода авторизации. Разработчики должны сделать так, чтобы злоумышленники не могли изменить выбранный метод авторизации, манипулируя параметрами, предоставленными клиентом.

Разработчикам следует быть особенно осторожными, если их попросят добавить новый метод авторизации, повышающий безопасность. К сожалению, разработчики часто решают создать новый метод авторизации поверх старой кодовой базы. Этот случай небезопасен, и злоумышленник может манипулировать клиентом для успешной авторизации транзакции, отправляя параметры старым методом, несмотря на то, что приложение уже переключилось на новый метод.

### 2.3 Данные для подтверждения транзакции должны быть сгенерированы на стороне сервера

Если разработчики решают передавать важные данные о транзакциях программным путем в компонент авторизации, они должны проявлять особую осторожность, чтобы предотвратить внесение каких-либо изменений клиентом в данные транзакции при авторизации. **Все важные данные о транзакциях должны быть проверены пользователем, сгенерированы и сохранены на сервере, а затем переданы компоненту авторизации без какой-либо возможности вмешательства со стороны клиента.**

А когда разработчики собирают важные данные о транзакциях на стороне клиента и передают их на сервер, вредоносное ПО может манипулировать этими данными и показывать поддельные данные о транзакциях в компоненте авторизации.

### 2.4 Приложение должно предотвращать грубое использование учетных данных для авторизации

**Разработчики должны убедиться, что их приложение не позволит злоумышленникам взломать транзакцию в момент отправки учетных данных для авторизации транзакции на сервер для проверки. После определенного количества неудачных попыток авторизации весь процесс авторизации транзакции следует перезапустить.** Кроме того, существуют другие методы предотвращения перебора и остановки других методов, связанных с автоматизацией, см. [Шпаргалка для проверки подлинности OWASP](Authentication_Cheat_Sheet.md#предотвращение атак методом перебора).

### 2.5 Приложение должно контролировать, какие переходы состояний транзакции разрешены

Авторизация транзакции обычно выполняется в несколько этапов, например:

1. Пользователь вводит данные транзакции.
2. Пользователь запрашивает авторизацию у приложения.
3. Приложение инициализирует механизм авторизации.
4. Пользователь проверяет/подтверждает данные транзакции.
5. Пользователь вводит в ответ учетные данные для авторизации.
6. Приложение проверяет авторизацию и выполняет транзакцию.

**Разработчики должны обеспечить, чтобы бизнес-логика для авторизации транзакции выполнялась в последовательном порядке, чтобы пользователи (или злоумышленники) не могли выполнять действия не по порядку или даже пропустить какой-либо из шагов. Это должно защитить от таких методов атаки, как:

- Перезапись данных транзакции до того, как пользователь введет учетные данные для авторизации
- Пропуск авторизации транзакции

 Смотрите [OWASP ASVS](https://owasp.org/www-project-application-security-verification-standard/) требование **15.1**).

### 2.6 Данные о транзакциях должны быть защищены от изменения

Разработчики не должны позволять злоумышленникам изменять данные транзакций, когда пользователь вводит их в первый раз. Некачественная реализация может привести к тому, что вредоносное ПО сможет:

1. Повторить первый шаг из раздела 2.5 (отправка данных транзакции) в фоновом режиме, прежде чем пользователь введет учетные данные для авторизации, а затем замените данные транзакции мошеннической транзакцией.
2. Создайт и добавит новые параметры данных транзакции в HTTP-запрос, который авторизует транзакцию. В таком случае некачественно реализованный процесс авторизации транзакции может привести к авторизации первоначальной транзакции, а затем к выполнению мошеннической транзакции (конкретный пример уязвимости [Время проверки соответствует времени использования](https://cwe.mitre.org/data/definitions/367.html)).

Существует несколько методов, которые могут предотвратить изменение данных транзакции во время авторизации:

1. Если данные транзакции будут изменены, код аннулирует все ранее введенные данные авторизации (например, сгенерированный OTP) и вызов.
2. Изменение данных транзакции может привести к перезапуску процесса авторизации.
3. Любая попытка изменить данные транзакции после входа пользователя в систему является атакой на систему, и она должна регистрироваться, отслеживаться и тщательно расследоваться.

### 2.7 Конфиденциальность данных о транзакциях должна быть защищена во время всех взаимодействий клиент-сервер

Процесс авторизации транзакции должен обеспечивать защиту конфиденциальности данных транзакции, которые пользователь будет авторизовывать (например, в разделе 2.5, шаги 2 и 4).

### 2.8 Система должна проверять выполнение каждой транзакции и убеждаться, что она была должным образом авторизована

Конечный результат процесса ввода и авторизации транзакции (как описано в разделе 2.5) также называется "выполнением транзакции". Перед выполнением транзакции должен быть установлен конечный контрольный шлюз, который проверяет, была ли транзакция должным образом авторизована пользователем. Этот элемент управления должен быть привязан к выполнению и предотвращать такие атаки, как:

- Соответствие времени проверки времени использования (TOCTOU) – пример в разделе 2.6
- Пропуск проверки авторизации в процессе ввода транзакции (см. Раздел 2.5)

### 2.9 Учетные данные для авторизации должны быть действительны только в течение ограниченного периода времени

При некоторых атаках вредоносная программа передает учетные данные для авторизации пользователя на сервер управления, а затем использует их с компьютера, находящегося под контролем злоумышленника. Часто этот процесс выполняется злоумышленником вручную. Чтобы предотвратить подобные атаки, сервер должен разрешать авторизацию транзакций только в течение ограниченного периода времени, который должен проходить между отправкой запроса (или OTP) и завершением авторизации. Кроме того, такие меры предосторожности также помогут предотвратить атаки, связанные с исчерпанием ресурсов. Этот период времени должен быть тщательно выбран, чтобы не нарушить нормальное поведение пользователя.

### 2.10 Учетные данные для авторизации должны быть уникальными для каждой операции

Чтобы предотвратить повторные атаки, каждый набор учетных данных для авторизации должен быть уникальным для каждой операции. Эти учетные данные могут быть сгенерированы различными методами в зависимости от механизма. Например, разработчики могут использовать временную метку, порядковый номер или случайное значение в подписанных данных транзакции или как часть задачи.

## Замечания

Вот некоторые другие вопросы, которые следует учитывать при осуществлении авторизации транзакций, но которые выходят за рамки данной инструкции:

- Какие транзакции должны быть авторизованы? Все транзакции или только некоторые из них? Каждое приложение отличается от других, и владелец приложения должен решить, должны ли быть авторизованы все транзакции или только некоторые из них. Разработчики должны учитывать анализ рисков, оценку рисков данного приложения и другие меры предосторожности, реализованные в приложении.
- **Мы рекомендуем использовать криптографические операции для защиты транзакций и обеспечения целостности, конфиденциальности и невозможности отказа.**
- **Критически важно обеспечить и защитить ключи подписи устройства во время "сопряжения" устройств, как и сам протокол подписи. Вредоносное ПО может попытаться внедрить, заменить или украсть ключи подписи.**
- Информированность пользователей: например, при использовании методов авторизации транзакций, когда пользователь вводит важные данные транзакции в компонент авторизации (например, на внешнее выделенное устройство или мобильное приложение), пользователи должны быть обучены переписывать данные транзакции из надежного источника, а не с экрана компьютера.
- **Существуют некоторые антивирусные решения, которые защищают от подобных угроз, но эти решения [не могут быть надежными на 100% effective](http://www.securing.pl/en/script-based-malware-detection-in-online-banking-security-overview/index.html) и должны использоваться только в качестве дополнительного уровня защиты.**
- Защищайте свои ключи подписи с помощью второго фактора, такого как пароли, биометрические данные и т.д., или используя защищенные элементы (TEE, TPM, смарт-карта).

## Рекомендации и ссылки для дополнительного прочтения

Рекомендации и ссылки для дополнительного прочтения:

- Wojciech Dworakowski: [E-banking transaction authorization - possible vulnerabilities, security verification and best practices for implementation. Presentation from AppSec EU 2015](http://www.slideshare.net/wojdwo/ebanking-transaction-authorization-appsec-eu-2015-amsterdam).
- Saar Drimer, Steven J. Murdoch, and Ross Anderson: [Optimised to Fail - Card Readers for Online Banking](http://www.cl.cam.ac.uk/~sjm217/papers/fc09optimised.pdf).
- Jakub Kałużny, Mateusz Olejarka: [Script-based Malware Detection in Online Banking Security Overview](http://www.securing.pl/en/script-based-malware-detection-in-online-banking-security-overview/index.html).
- [List of websites and whether or not they support 2FA](https://twofactorauth.org/).
- Laerte Peotta, Marcelo D. Holtz, Bernardo M. David, Flavio G. Deus, Rafael Timóteo de Sousa Jr: [A Formal Classification Of Internet Banking Attacks and Vulnerabilities](http://airccse.org/journal/jcsit/0211ijcsit13.pdf).
- Marco Morana, Tony Ucedavelez: [Threat Modeling of Banking Malware-Based Attacks](https://owasp.org/www-pdf-archive/Marco_Morana_and_Tony_UV_-_Threat_Modeling_of_Banking_Malware.pdf).
- OWASP [Anti-Malware - Knowledge Base](https://wiki.owasp.org/index.php/OWASP_Anti-Malware_-_Knowledge_Base).
- OWASP [Anti-Malware Project - Awareness Program](https://wiki.owasp.org/index.php/OWASP_Anti-Malware_Project_-_Awareness_Program).
- Arjan Blom , Gerhard de Koning Gans , Erik Poll , Joeri de Ruiter , and Roel Verdult: [Designed to Fail - A USB-Connected Reader for Online Banking](http://www.cs.ru.nl/~rverdult/Designed_to_Fail_A_USB-Connected_Reader_for_Online_Banking-NORDSEC_2012.pdf)
