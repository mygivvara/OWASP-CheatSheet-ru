# Шпаргалка по непроверенным перенаправлениям и форвардам

## Вступление

Неподтвержденные переадресации возможны, когда веб-приложение принимает ненадежные входные данные, что может привести к перенаправлению запроса веб-приложением на URL-адрес, содержащийся в ненадежных входных данных. Изменяя ненадежные входные данные URL-адреса на вредоносный сайт, злоумышленник может успешно запустить фишинговую программу и украсть учетные данные пользователя.

Поскольку имя сервера в измененной ссылке идентично исходному сайту, попытки фишинга могут выглядеть более правдоподобно. Неподтвержденные атаки перенаправления и переадресации также могут быть использованы для злонамеренного создания URL-адреса, который прошел бы проверку контроля доступа приложения, а затем перенаправил бы злоумышленника к привилегированным функциям, к которым он обычно не смог бы получить доступ.

## Безопасное перенаправление URL-адресов

Когда мы хотим автоматически перенаправить пользователя на другую страницу (без каких-либо действий посетителя, таких как переход по гиперссылке), вы можете реализовать следующий код:

Java

```java
response.sendRedirect("http://www.mysite.com");
```

PHP

```php
<?php
/* Перенаправление браузера */
header("Location: http://www.mysite.com");
/* Завершите, чтобы предотвратить выполнение остальной части кода */
exit;
?>
```

ASP .NET

```csharp
Response.Redirect("~/folder/Login.aspx")
```

Rails

```ruby
redirect_to login_path
```

Rust actix web

```rust
  Ok(HttpResponse::Found()
        .insert_header((header::LOCATION, "https://mysite.com/"))
        .finish())
```

В приведенных выше примерах URL-адрес явно объявлен в коде, и злоумышленник не может им манипулировать.

## Опасные перенаправления URL-адресов

Следующие примеры демонстрируют небезопасный код перенаправления и переадресации.

### Пример опасного перенаправления URL-адреса 1

Следующий Java-код получает URL-адрес из параметра с именем `url` ([GET или POST](https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequest.html#getParameter-java.lang.String-)) и перенаправляет на этот URL-адрес:

```java
response.sendRedirect(request.getParameter("url"));
```

Следующий PHP-код получает URL-адрес из строки запроса (через параметр с именем `url`) и затем перенаправляет пользователя на этот URL-адрес. Кроме того, PHP-код после этой функции header() будет продолжать выполняться, поэтому, если пользователь настроит свой браузер на игнорирование перенаправления, он сможет получить доступ к остальной части страницы.

```php
$redirect_url = $_GET['url'];
header("Location: " . $redirect_url);
```

Аналогичный пример уязвимого кода на C\# .NET:

```csharp
string url = request.QueryString["url"];
Response.Redirect(url);
```

И в Rails:

```ruby
redirect_to params[:url]
```

Rust actix web

```rust
  Ok(HttpResponse::Found()
        .insert_header((header::LOCATION, query_string.path.as_str()))
        .finish())
```

Приведенный выше код уязвим для атаки, если для проверки достоверности URL-адреса не используется проверка подлинности или дополнительные методы контроля. Эта уязвимость может быть использована для фишинговой атаки, перенаправляя пользователей на вредоносный сайт.

Если проверка не выполняется, злоумышленник может создать гиперссылку, чтобы перенаправить ваших пользователей, например, на не прошедший проверку вредоносный веб-сайт:

```text
 http://example.com/example.php?url=http://malicious.example.com
```

Пользователь видит ссылку, ведущую на исходный надежный сайт (`example.com`), и не осознает, что может произойти перенаправление

### Пример опасного перенаправления URL-адреса 2

[ASP .NET MVC 1 и 2 websites](https://docs.microsoft.com/en-us/aspnet/mvc/overview/security/preventing-open-redirection-attacks) особенно уязвимы для атак с открытым перенаправлением. Чтобы избежать этой уязвимости, вам необходимо применить MVC 3.

Код для действия входа в систему в ASP.NET Ниже показано приложение MVC 2. После успешного входа в систему контроллер возвращает перенаправление на returnUrl. Вы можете видеть, что проверка для параметра returnUrl не выполняется.

ASP.NET Действие входа в систему MVC 2 в `AccountController.cs` (смотрите ссылку на документы Microsoft, приведенную выше для контекста):

```csharp
[HttpPost]
 public ActionResult LogOn(LogOnModel model, string returnUrl)
 {
   if (ModelState.IsValid)
   {
     if (MembershipService.ValidateUser(model.UserName, model.Password))
     {
       FormsService.SignIn(model.UserName, model.RememberMe);
       if (!String.IsNullOrEmpty(returnUrl))
       {
         return Redirect(returnUrl);
       }
       else
       {
         return RedirectToAction("Index", "Home");
       }
     }
     else
     {
       ModelState.AddModelError("", "The user name or password provided is incorrect.");
     }
   }

   // Если мы зашли так далеко, значит, что-то не получилось, повторите отображение формы
   return View(model);
 }
```

### Пример опасного Forward

Когда приложения разрешают ввод данных пользователем для пересылки запросов между различными частями сайта, приложение должно проверить, что пользователь авторизован для доступа к URL-адресу, выполняет функции, которые он предоставляет, и это соответствующий запрос URL-адреса.

Если приложению не удается выполнить эти проверки, созданный злоумышленником URL-адрес может пройти проверку контроля доступа приложения и затем перенаправить злоумышленника к административной функции, которая обычно не разрешена.

Пример:

```text
http://www.example.com/function.jsp?fwd=admin.jsp
```

Следующий код представляет собой Java-сервлет, который получит запрос `GET` с параметром URL с именем `fwd` в запросе на пересылку по адресу, указанному в параметре URL. Сервлет получит значение параметра URL [из request](https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequest.html#getParameter-java.lang.Строка-) и завершите переадресацию на стороне сервера, прежде чем отвечать браузеру.

```java
public class ForwardServlet extends HttpServlet
{
  protected void doGet(HttpServletRequest request, HttpServletResponse response)
                    throws ServletException, IOException {
    String query = request.getQueryString();
    if (query.contains("fwd"))
    {
      String fwd = request.getParameter("fwd");
      try
      {
        request.getRequestDispatcher(fwd).forward(request, response);
      }
      catch (ServletException e)
      {
        e.printStackTrace();
      }
    }
  }
}
```

## Предотвращение непроверенных перенаправлений и переадресаций

Безопасное использование перенаправлений и форвардеров может быть обеспечено несколькими способами:

- Просто избегайте использования перенаправлений и переадресаций.
- Если они используются, не используйте URL-адрес в качестве пользовательского ввода для назначения.
- По возможности попросите пользователя указать краткое имя, идентификатор или токен, которые сопоставляются на стороне сервера с полным целевым URL-адресом.
    - Это обеспечивает высочайшую степень защиты от атаки, направленной на изменение URL-адреса.
    - Будьте осторожны, чтобы это не привело к возникновению уязвимости при перечислении, когда пользователь может перебирать идентификаторы, чтобы найти все возможные цели перенаправления
- Если избежать ввода данных пользователем невозможно, убедитесь, что указанное **значение** является допустимым, подходящим для приложения и **авторизованным** для пользователя.
- Очистите вводимые данные, создав список надежных URL-адресов (списки хостов или регулярное выражение).
    - Это должно основываться на подходе с использованием разрешенного списка, а не запрещенного списка.
- Заставьте все перенаправления сначала перейти на страницу, уведомляющую пользователей о том, что они покидают ваш сайт, с четко указанным пунктом назначения, и попросите их нажать на ссылку для подтверждения.

### Проверка URL-адресов

Проверка и очистка пользовательского ввода, чтобы определить, безопасен ли URL-адрес, не является тривиальной задачей. Подробные инструкции по реализации проверки URL описаны [в шпаргалке по предотвращению подделки запросов на стороне сервера SSRF](Server_Side_Request_Forgery_Prevention_Cheat_Sheet.md#прикладной уровень)

## Ссылки на литературу

- [CWE Entry 601 on Open Redirects](http://cwe.mitre.org/data/definitions/601.html).
- [WASC Article on URL Redirector Abuse](http://projects.webappsec.org/w/page/13246981/URL%20Redirector%20Abuse)
- [Google blog article on the dangers of open redirects](http://googlewebmastercentral.blogspot.com/2009/01/open-redirect-urls-is-your-site-being.html).
- [Preventing Open Redirection Attacks (C\#)](http://www.asp.net/mvc/tutorials/security/preventing-open-redirection-attacks).
