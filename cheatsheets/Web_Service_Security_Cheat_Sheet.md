# Шпаргалка по безопасности веб-сервиса

## Вступление

Эта статья посвящена руководству по обеспечению безопасности веб-сервисов и предотвращению атак, связанных с веб-сервисами.

Пожалуйста, обратите внимание, что из-за различий в реализации различных платформ, эта шпаргалка составлена на высоком уровне.

## Транспортная конфиденциальность

Конфиденциальность передачи данных защищает от подслушивания и атак типа "человек посередине" (mitm), направленных против обмена данными между веб-сервисами и сервером.

**Правило**: Все сообщения с веб-службами и между ними, содержащие конфиденциальные функции, аутентифицированный сеанс или передачу конфиденциальных данных, должны быть зашифрованы с использованием правильно настроенного [TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security). Это рекомендуется делать, даже если сами сообщения зашифрованы, поскольку [TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security) обеспечивает множество преимуществ, помимо конфиденциальности трафика, включая защиту целостности, защиту от повторного воспроизведения и аутентификацию сервера. Дополнительную информацию о том, как это сделать правильно, смотрите в [Руководстве по безопасности транспортного уровня](Transport_Layer_Security_Cheat_Sheet.md).

## Аутентификация на сервере

**Правило**: TLS должен использоваться для аутентификации поставщика услуг перед потребителем услуг. Потребитель услуги должен убедиться, что сертификат сервера выдан надежным провайдером, срок действия которого не истек, не отозван, соответствует доменному имени сервиса и что сервер доказал, что у него есть закрытый ключ, связанный с сертификатом открытого ключа (путем правильной подписи чего-либо или успешной расшифровки чего-либо, зашифрованного с помощью связанный с ним открытый ключ).

## Аутентификация пользователя

Аутентификация пользователя проверяет личность пользователя или системы, пытающейся подключиться к сервису. Такая аутентификация обычно является функцией контейнера веб-сервиса.

**Правило**: Если используется, базовая аутентификация должна выполняться по протоколу [TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security), но базовая аутентификация не рекомендуется, поскольку она раскрывает секреты в виде текста (в кодировке base64) в заголовках HTTP.

**Правило**: Проверка подлинности по сертификату клиента с использованием [Mutual-TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security) является распространенной формой проверки подлинности, которая рекомендуется при необходимости. Смотрите: [Шпаргалка по проверке подлинности](Authentication_Cheat_Sheet.md).

## Транспортное кодирование

[SOAP](https://en.wikipedia.org/wiki/SOAP) стили кодирования предназначены для перемещения данных между программными объектами в формат XML и обратно.

**Правило**: Применяйте один и тот же стиль кодирования между клиентом и сервером.

## Целостность сообщения

Это для данных, находящихся в состоянии покоя. Целостность передаваемых данных может быть легко обеспечена с помощью [TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security).

При использовании [криптографии с открытым ключом] (https://en.wikipedia.org/wiki/Public-key_cryptography) шифрование гарантирует конфиденциальность, но не целостность, поскольку открытый ключ получателя является открытым. По той же причине шифрование не гарантирует идентификацию отправителя.

**Правило**: Для данных в формате XML используйте цифровые подписи в формате XML для обеспечения целостности сообщения с использованием закрытого ключа отправителя. Эта подпись может быть проверена получателем с помощью цифрового сертификата отправителя (открытого ключа).

## Конфиденциальность сообщений

Элементы данных, которые должны оставаться конфиденциальными, должны быть зашифрованы с использованием надежного шифра с достаточной длиной ключа для предотвращения несанкционированного доступа.

**Правило**: Сообщения, содержащие конфиденциальные данные, должны быть зашифрованы с использованием надежного шифрования. Это может быть транспортное шифрование или шифрование сообщений.

**Правило**: Сообщения, содержащие конфиденциальные данные, которые должны оставаться зашифрованными после получения, должны быть зашифрованы с использованием надежного шифрования данных, а не только транспортного шифрования.

## Авторизация

Веб-службам необходимо авторизовывать клиентов веб-служб так же, как веб-приложения авторизуют пользователей. Веб-службе необходимо убедиться, что клиент веб-службы авторизован для выполнения определенного действия (грубого (coarse-grained)) с запрошенными данными (мелкого (fine-grained)).

**Правило**: Веб-служба должна авторизовать своих клиентов, независимо от того, имеют ли они доступ к данному методу. После проверки подлинности веб-служба должна проверить привилегии запрашивающего объекта, есть ли у него доступ к запрошенному ресурсу. Это должно выполняться при каждом запросе, и к конфиденциальным ресурсам, таким как смена пароля, основные контактные данные, такие как электронная почта, физический адрес, инструкции по оплате или доставке, добавлен механизм авторизации "запрос-ответ".

**Правило**: Убедитесь, что доступ к функциям администрирования и управления в приложении веб-службы ограничен администраторами веб-служб. В идеале любые административные возможности должны быть в приложении, которое полностью отделено от веб-служб, управляемых этими возможностями, что полностью отделяет обычных пользователей от этих важных функций.

## Проверка подлинности схемы

Проверка схемы обеспечивает соблюдение ограничений и синтаксиса, определенных схемой.

**Правило**: Веб-службы должны проверять полезную нагрузку [SOAP](https://en.wikipedia.org/wiki/SOAP) на соответствие соответствующему определению XML-схемы ([XSD](https://www.w3schools.com/xml/schema_intro.asp)).

**Правило**: Параметр [XSD](https://www.w3schools.com/xml/schema_intro.asp), определенный для веб-сервиса [SOAP](https://en.wikipedia.org/wiki/SOAP), должен, как минимум, определять максимальную длину и набор символов для каждого параметра, который разрешается передавать в веб-сервис и из веб-сервиса.

**Правило**: [XSD](https://www.w3schools.com/xml/schema_intro.asp), определенный для веб-службы [SOAP](https://en.wikipedia.org/wiki/SOAP), должен определять строгие шаблоны проверки (в идеале, разрешать список) для всех параметров фиксированного формата (например, почтовых индексов, телефонных номеров, значений списка и т.д.).

## Проверка содержимого

**Правило**: Как и любое веб-приложение, веб-службы должны проверять вводимые данные перед их использованием. Проверка содержимого для ввода в формате XML должна включать:

- Проверка на наличие искаженных XML-объектов.
- Проверка на [атаки с использованием XML-бомб (XML Bomb attacks)](https://en.wikipedia.org/wiki/Billion_laughs_attack).
- Проверка входных данных с использованием строгого списка разрешений.
- Проверка на [атаки с использованием внешних объектов (external entity attacks)](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_%28XXE%29_Processing).

## Выходное кодирование

Веб-службы должны гарантировать, что выходные данные, отправляемые клиентам, закодированы для использования в виде данных, а не в виде сценариев. Это становится очень важным, когда клиенты веб-служб используют выходные данные для отображения HTML-страниц прямо или косвенно с помощью объектов AJAX.

**Правило**: Все правила кодирования выходных данных применяются в соответствии с [Шпаргалкой по предотвращению межсайтового скриптинга](Cross_Site_Scripting_Prevention_Cheat_Sheet.md).

## Защита от вирусов

[SOAP](https://en.wikipedia.org/wiki/SOAP) предоставляет возможность прикреплять файлы и документы к сообщениям [SOAP](https://en.wikipedia.org/wiki/SOAP). Это дает хакерам возможность прикреплять вирусы и вредоносные программы к этим сообщениям [SOAP](https://en.wikipedia.org/wiki/SOAP).

**Правило**: Убедитесь, что установлена технология проверки на вирусы, желательно в режиме онлайн, чтобы файлы и вложения можно было проверять перед сохранением на диске.

**Правило**: Убедитесь, что технология проверки на вирусы регулярно обновляется с учетом последних определений вирусов/правил.

## Размер сообщения

Веб-службы, такие как веб-приложения, могут стать мишенью для DOS-атак, поскольку они автоматически отправляют веб-службам тысячи сообщений большого размера [SOAP](https://en.wikipedia.org/wiki/SOAP). Это либо выводит приложение из строя, делая его неспособным отвечать на легитимные сообщения, либо может привести к его полному отключению.

**Правило**: [SOAP](https://en.wikipedia.org/wiki/SOAP) Размер сообщений должен быть ограничен соответствующим пределом размера. Большее ограничение размера (или его полное отсутствие) увеличивает шансы на успешную DoS-атаку.

## Доступность

### Ограничение ресурсов

Во время обычной работы веб-сервисам требуются вычислительные мощности, такие как циклы процессора и память. Из-за сбоев в работе или во время атаки веб-сервису может потребоваться слишком много ресурсов, что приводит к нестабильной работе хост-системы.

**Правило**: Ограничьте количество циклов процессора, которое может использовать веб-служба, исходя из ожидаемой скорости обслуживания, чтобы обеспечить стабильную работу системы.

**Правило**: Ограничьте объем памяти, который может использовать веб-служба, чтобы избежать нехватки памяти в системе. В некоторых случаях хост-система может начать отключать процессы, чтобы освободить память.

**Правило**: Ограничьте количество одновременно открытых файлов, сетевых подключений и запущенных процессов.

### Пропускная способность сообщений

Пропускная способность представляет собой количество запросов к веб-сервисам, обработанных за определенный промежуток времени.

**Правило**: Конфигурация должна быть оптимизирована для обеспечения максимальной пропускной способности передачи сообщений, чтобы избежать возникновения ситуаций, подобных DoS.

### Защита от отказа в обслуживании в формате XML (XML DoS)

Отказ в обслуживании в формате XML, вероятно, является наиболее серьезной атакой на веб-службы. Таким образом, веб-служба должна обеспечить следующую проверку:

**Правило**: Проверка на соответствие рекурсивным пейлоадам.

**Правило**: Проверка на соответствие чрезмерно большим пейлоадам.

**Правило**: Защита от [расширения XML-объекта (XML entity expansion)](https://www.ws-attacks.org/XML_Entity_Expansion).

**Правило**: Проверка на соответствие чрезмерно длинным именам элементов. Если вы работаете с веб-службами, основанными на [SOAP](https://en.wikipedia.org/wiki/SOAP), имена элементов будут соответствовать действиям [SOAP](https://en.wikipedia.org/wiki/SOAP).

Эта защита должна быть обеспечена вашим анализатором XML/средством проверки схемы. Для проверки создайте тестовые примеры, чтобы убедиться, что ваш анализатор устойчив к этим типам атак.

## Профиль безопасности конечных точек

**Правило**: Веб-службы должны соответствовать [Web Services-Interoperability (WS-I)] (https://en.wikipedia.org/wiki/Web_Services_Interoperability) как минимум базовому профилю.
