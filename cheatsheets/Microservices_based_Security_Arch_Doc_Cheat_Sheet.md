# Шпаргалка по безопасности Arch Doc на основе микросервисов

## Вступление

Архитектура микросервисов все чаще используется для проектирования и внедрения прикладных систем как в облачных, так и в локальных инфраструктурах. На этапах разработки и внедрения приложений необходимо решить множество проблем безопасности. Для решения некоторых проблем безопасности необходимо собирать информацию об архитектуре приложения, связанную с безопасностью.
Цель этой статьи - предоставить конкретное предложение о подходе к сбору информации об архитектуре на основе микросервисов для обеспечения безопасности приложения.

## Контекст

При обеспечении безопасности приложений на основе архитектуры микросервисов архитекторы/инженеры по безопасности обычно сталкиваются со следующими вопросами (на которые в основном ссылаются в [Стандартном проекте проверки безопасности приложений OWASP](https://github.com/OWASP/ASVS) в разделе [Версия 1 "Архитектура, проектирование и моделирование угроз Requirements"](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)):

1. Моделирование угроз и применение принципа наименьших привилегий:
    - Какие области или ключи API минимально необходимы микросервису для доступа к другим API микросервиса?
    - Какие разрешения минимально необходимы микросервису для доступа к базе данных или очереди сообщений?
2. Анализ утечки данных:
    - Какие хранилища или очереди сообщений содержат конфиденциальные данные?
    - Выполняет ли микросервис чтение/запись из определенной базы данных или очереди сообщений?
    - Какие микросервисы вызываются выделенным микросервисом? Какие данные передаются между микросервисами?
3. Анализ поверхности атаки:
    - Какие конечные точки микросервисов необходимо проверить во время тестирования безопасности?

В большинстве случаев существующая документация по архитектуре приложений не подходит для ответа на эти вопросы. В следующих разделах предлагается информация о безопасности конкретной архитектуры, которая может быть собрана для ответа на вышеуказанные вопросы.

## Цель

Цель шпаргалки - объяснить, какую информацию о безопасности конкретной архитектуры можно собрать, чтобы ответить на вышеприведенные вопросы, и предложить конкретный подход к сбору информации об архитектуре на основе микросервисов для обеспечения безопасности приложения.

## Предложение

### Сбор информации о базовых элементах

#### Определение и описание сервисов, связанных с функциональностью приложений

Сервисы, связанные с функциональностью приложений, реализуют один или несколько бизнес-процессов или функциональных возможностей (например, хранение сведений о клиентах, хранение и отображение каталога продуктов). Соберите информацию о перечисленных ниже параметрах, относящихся к каждой функциональной службе приложения.

| Имя параметра | Описание |
| :--- | :--- |
| Service name (ID) | Уникальное имя или идентификатор службы (ID)
| Short description | Краткое описание бизнес-процесса или функционала, реализованного микросервисом
| Link to source code repository | Укажите ссылку на репозиторий исходного кода сервиса
| Development Team | Укажите ссылку на репозиторий исходного кода сервиса
| API definition | Если микросервис предоставляет доступ к внешнему интерфейсу, укажите ссылку на описание интерфейса (например, спецификацию открытого API). Рекомендуется определить используемую схему безопасности, например, определить области или ключи API, необходимые для вызова выделенной конечной точки (например, [см.](https://swagger.io/docs/specification/authentication/)).
| The microservice architecture description | Укажите ссылку на схему архитектуры микросервиса, описание (если таковое имеется).|
| Link to runbook | Укажите ссылку на runbook с микросервисом |

#### Идентифицировать и описать инфраструктурные сервисы

Инфраструктурные сервисы, включая удаленные сервисы, могут реализовывать аутентификацию, авторизацию, регистрацию и обнаружение сервисов, мониторинг безопасности, ведение журнала и т.д. Собирать информацию о параметрах, перечисленных ниже, относящихся к каждому инфраструктурному сервису.

| Имя параметра | Описание |
| :--- | :--- |
|Service name (ID) | Уникальное имя или идентификатор службы
|Short description | Краткое описание функциональных возможностей, реализуемых сервисом (например, аутентификация, авторизация, регистрация и обнаружение сервиса, ведение журнала, мониторинг безопасности, API-шлюз).
|Link to source code repository | Укажите ссылку на репозиторий исходного кода сервиса (если применимо).
|Link to the service documentation | Укажите ссылку на сервисную документацию, которая включает в себя определение API сервиса, руководство по эксплуатации/runbook и т.д.

#### Определите и опишите хранилища данных

Соберите информацию о перечисленных ниже параметрах, относящихся к каждому хранилищу данных.

| Имя параметра | Описание |
| :--- | :--- |
|Storage name (ID) | Уникальное имя или идентификатор хранилища
|Software type | Укажите программное обеспечение, реализующее хранение данных (например, PostgreSQL, Redis, Apache Cassandra).

#### Определите и опишите очереди сообщений

Системы обмена сообщениями (например, RabbitMQ или Apache Kafka) используются для реализации механизма асинхронного взаимодействия с микросервисами. Соберите информацию о параметрах, перечисленных ниже, относящихся к каждой очереди сообщений.

| Имя параметра | Описание |
| :--- | :--- |
|Message queue (ID) | Уникальное имя или идентификатор очереди сообщений
|Software type | Укажите программное обеспечение, реализующее очередь сообщений (например, RabbitMQ, Apache Kafka).

#### Идентифицируйте и описывайте активы данных

Идентифицируйте и описывайте активы данных, которые обрабатываются системными микросервисами/службами. Рекомендуется сначала идентифицировать активы, которые представляют ценность с точки зрения безопасности (например, "Информация о пользователе", "Платеж"). Соберите информацию о перечисленных ниже параметрах, относящихся к каждому активу.

| Имя параметра | Описание|
| :--- | :--- |
| Asset name (ID) | Уникальное имя или идентификатор актива
| Protection level | Укажите уровень защиты активов (например, личные данные, конфиденциальность).
| Additional info | Добавьте уточняющую информацию

### Соберите информацию о связях между компоновочными блоками

#### Определите отношения "обслуживание-хранение"

Соберите информацию о перечисленных ниже параметрах, относящихся к каждому отношению "обслуживание-хранение".

| Имя параметра | Описание |
| :--- | :--- |
| Service name (ID) | Укажите имя службы (ID), указанное выше
| Storage name (ID) | Укажите имя хранилища (ID), указанное выше
| Access type | Укажите тип доступа, например "Чтение" или "Чтение/запись".

#### Идентификация синхронных коммуникаций "от службы к службе"

Соберите информацию о перечисленных ниже параметрах, относящихся к каждой синхронной связи "сервис-сервис".

| Имя параметра | Описание |
| :--- | :--- |
| Caller service name (ID) | Укажите имя вызывающей службы (ID), указанное выше
| Called service name (ID) | Укажите имя вызываемой службы (ID), определенное выше
| Protocol/framework used| Укажите протокол/фреймворк, используемый для связи, например HTTP (REST, SOAP), Apache Thrift, rpc
| Short description | Кратко опишите цель обмена данными (запросы на запрос информации или запросы/команды для бизнес-функции, изменяющей состояние) и данные, передаваемые между службами (если возможно, в терминах активов, определенных выше).

#### Определите асинхронную связь "сервис-сервис"

Соберите информацию о перечисленных ниже параметрах, относящихся к каждой асинхронной связи "сервис-сервис".

| Имя параметра | Описание |
| :--- | :--- |
| Publisher service name (ID) | Укажите имя (ID) службы издателя, указанное выше
| Subscriber service name (ID) | Укажите имя (ID) абонентской службы, указанное выше
| Message queue (ID) | Укажите очередь сообщений (ID), определенную выше
| Short description | Кратко опишите цель обмена данными (получение информации или команд для бизнес-функции, изменяющей состояние) и данные, передаваемые между службами (если возможно, в терминах активов, определенных выше).

#### Определите отношения "актив-хранилище"

Соберите информацию о перечисленных ниже параметрах, относящихся к каждому отношению "актив-хранилище".

| Имя параметра | Описание |
| :--- | :--- |
| Asset name (ID) | Имя актива (ID), определенное выше
| Storage name (ID) | Укажите имя хранилища (ID), указанное выше
| Storage type | Укажите тип хранилища для ресурса, например "золотой источник" или "кэш".

### Создайте графическое представление архитектуры приложения

Желательно создать графическое представление архитектуры приложения (структурных блоков и взаимосвязей, определенных выше) в виде графика вызовов служб или диаграммы потоков данных. Для этого можно использовать специальные программные средства (например, Enterprise Architect) или [язык DOT](https://en.wikipedia.org/wiki/DOT_%28graph_description_language%29). Смотрите пример использования языка ТОЧЕК [здесь](https://gist.github.com/vladgolubev/80c5523336ddec3859c0e90d9a070882).

### Используйте собранную информацию при разработке безопасного программного обеспечения

Собранная информация может быть полезна для обеспечения безопасности приложений, например, при определении требований к безопасности, моделировании угроз или тестировании безопасности. В разделах ниже приведены примеры действий, связанных с защитой архитектуры приложения (а также ее привязкой к проектам OWASP), и советы по их реализации с использованием информации, собранной выше.

#### Анализ поверхности атаки

##### Советы по внедрению

Чтобы перечислить конечные точки микросервисов, которые необходимо протестировать во время тестирования безопасности и проанализировать во время моделирования угроз, проанализируйте данные, собранные в следующих разделах:

- Определите и опишите службы, связанные с функциональностью приложения (параметр "Определение API").
- Идентифицировать и описать инфраструктурные сервисы (параметр "Ссылка на сервисную документацию")

##### Сопоставление с проектами OWASP

- [OWASP ASVS, версия 1 "Требования к архитектуре, проектированию и моделированию угроз", #1.1.2](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)
- [Чит для анализа поверхности атаки OWASP Sheet](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Attack_Surface_Analysis_Cheat_Sheet.md)

#### Анализ утечки данных

##### Советы по внедрению

Для анализа возможной утечки данных проанализируйте данные, собранные в следующих разделах:

- Определите и опишите ресурсы данных
- Определите отношения "сервис-хранилище"
- Определите синхронную связь "сервис-сервис"
- Определить асинхронные связи "сервис-сервис"
- Определить отношения "актив-хранилище"

##### Сопоставление с проектами OWASP

- [OWASP ASVS, версия 1 "Требования к архитектуре, проектированию и моделированию угроз", #1.1.2](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)
- [OWASP Top 10-2017: 3-Конфиденциальный доступ к данным](https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A 3-Конфиденциальный доступ к данным)

#### Обоснование границ доверия приложения, компонентов и значимых потоков данных

##### Советы по внедрению

Для проверки документации и обоснования всех границ доверия приложения, компонентов и важных потоков данных проанализируйте данные, собранные в следующих разделах:

- Определите и опишите функциональные службы приложения
- Определите и опишите инфраструктурные службы
- Определите и опишите хранилища данных
- Определите и опишите очереди сообщений
- Определить отношения "сервис-хранилище"
- Определить синхронные связи "сервис-сервис"
- Определить асинхронные связи "сервис-сервис"

##### Сопоставление с проектами OWASP

- [OWASP ASVS, версия 1 "Требования к архитектуре, проектированию и моделированию угроз", #1.1.4](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)

#### Анализ высокоуровневой архитектуры приложения

##### Советы по внедрению

Для проверки определения и анализа безопасности высокоуровневой архитектуры приложения и всех подключенных удаленных служб проанализируйте данные, собранные в следующих разделах:

- Определите и опишите функциональные службы приложения
- Определите и опишите инфраструктурные службы.
- Идентифицировать и описывать хранилища данных
- Идентифицировать и описывать очереди сообщений

##### Соответствие проектам OWASP

- [OWASP ASVS, версия 1 "Требования к архитектуре, проектированию и моделированию угроз", #1.1.5](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)

#### Внедрение централизованной проверки средств контроля безопасности

##### Советы по внедрению

Чтобы проверить внедрение централизованных, простых (экономичных по дизайну), проверенных, безопасных и многократно используемых средств контроля безопасности, чтобы избежать дублирования, отсутствия, неэффективности или небезопасности средств контроля, проанализируйте данные, собранные в разделе "Идентификация и описание инфраструктурных служб".

##### Соответствие проектам OWASP

- [OWASP ASVS, V1 "Требования к архитектуре, проектированию и моделированию угроз", #1.1.6](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)

#### Применение принципа наименьших привилегий

##### Советы по внедрению

Чтобы определить минимально необходимые разрешения для микросервисов, проанализируйте данные, собранные в следующих разделах:

- Определите и опишите сервисы, связанные с функциональностью приложения (параметр "Определение API")
- Определите отношения "сервис-хранилище"
- Определите синхронную связь "от службы к службе"
- Определите асинхронную связь "от службы к службе"

##### Соответствие проектам OWASP

- [OWASP ASVS, версия 1 "Требования к архитектуре, проектированию и моделированию угроз", #1.4.3](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)

#### Идентификация и классификация конфиденциальных данных

##### Советы по внедрению

Чтобы убедиться, что все конфиденциальные данные идентифицированы и классифицированы по уровням защиты, проанализируйте данные, собранные в следующих разделах:

- Идентифицируйте и опишите ресурсы данных
- Определите отношения "активы-хранилище".

##### Соответствие проектам OWASP

- [OWASP ASVS, V1 "Требования к архитектуре, проектированию и моделированию угроз", #1.8.1](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)

#### Проверка бизнес-функций компонентов приложений и функций безопасности

##### Советы по внедрению

Чтобы проверить определение и документацию всех компонентов приложения с точки зрения бизнес-функций или функций безопасности, которые они предоставляют, проанализируйте данные, собранные в следующих разделах (параметр "Краткое описание"):

- Идентифицируйте и опишите сервисы, связанные с функциональностью приложений
- Идентифицируйте и опишите инфраструктурные сервисы

##### Сопоставление с проектами OWASP

- [OWASP ASVS, версия 1 "Требования к архитектуре, проектированию и моделированию угроз", #1.11.1](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)