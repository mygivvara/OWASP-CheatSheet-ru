# Шпаргалка по управлению JavaScript от сторонних разработчиков

## Вступление

Теги, также известные как маркетинговые теги, аналитические теги и т.д., представляют собой небольшие фрагменты JavaScript на веб-странице. Они также могут быть элементами HTML-изображений, когда JavaScript отключен. Их назначение - сбор данных о действиях веб-пользователя и контексте просмотра для использования владельцем веб-страницы в маркетинговых целях.

JavaScript-теги сторонних производителей (далее - **теги**) можно разделить на два типа:

- Теги пользовательского интерфейса.
- Аналитические теги.

Теги пользовательского интерфейса должны выполняться на клиенте, поскольку они изменяют DOM; отображение диалогового окна или изображения, изменение текста и т.д.

Аналитические теги отправляют информацию обратно в базу данных маркетинговой информации; например, информацию о том, какое действие пользователь только что совершил, метаданные браузера, информацию о местоположении, метаданные страницы и т.д. Смысл использования аналитических тегов заключается в предоставлении данных из DOM браузера пользователя поставщику для проведения маркетингового анализа в той или иной форме. Эти данные могут быть любыми, доступными в DOM. Данные используются для навигации пользователя и анализа потока кликов, идентификации пользователя для определения дальнейшего контента для показа и т.д., а также для различных функций маркетингового анализа.

Термин **хост** относится к исходному сайту, на который заходит пользователь, такому как сайт покупок или новостной сайт, который содержит или извлекает и выполняет сторонний JavaScript-тег для маркетингового анализа действий пользователя.

## Основные риски

Наибольший риск представляет собой компрометация стороннего JavaScript-сервера и внедрение вредоносного JavaScript в исходный тег JavaScript. Это произошло в 2018 году и, вероятно, ранее.

Использование стороннего JS-кода в веб-приложении требует рассмотрения, в частности, трех рисков:

1. Потеря контроля над изменениями в клиентском приложении,
2. Выполнение произвольного кода в клиентских системах,
3. Раскрытие или утечка конфиденциальной информации третьим лицам.

### Риск 1: Потеря контроля над изменениями в клиентском приложении

Этот риск возникает из-за того, что обычно нет гарантии, что код, размещенный у стороннего разработчика, останется таким же, каким его видят разработчики и тестировщики: в любой момент в сторонний код могут быть добавлены новые функции, что потенциально может нарушить интерфейс или потоки данных и подвергнуть риску систему. доступность вашего приложения для его пользователей/заказчиков.

Типичные средства защиты включают, но не ограничиваются ими: собственное зеркальное отображение скриптов (для предотвращения изменений третьими лицами), целостность подресурса (для обеспечения перехвата на уровне браузера) и безопасную передачу кода третьей стороны (для предотвращения изменений во время передачи). Смотрите ниже для получения более подробной информации.

### Риск 2: Выполнение произвольного кода в клиентских системах

Этот риск возникает из-за того, что сторонний JavaScript-код редко просматривается запрашивающей стороной перед его интеграцией в веб-сайт/приложение. Когда клиент достигает веб-сайта/приложения, на котором размещен хостинг, этот сторонний код выполняется, предоставляя третьей стороне точно такие же привилегии, которые были предоставлены пользователю (аналогично [XSS-атакам](https://owasp.org/www-community/attacks/xss/)).

Любое тестирование, проведенное до запуска в производство, частично теряет силу, включая `тестирование AST` ([IAST](https://www.veracode.com/security/interactive-application-security-testing-iast), [RAST](https://www.veracode.com/sites/default/files/pdf/resources/whitepapers/what-is-rasp.pdf), [SAST](https://www.sqreen.com/web-application-security/what-is-sast), [DAST](https://www.sqreen.com/web-application-security/what-is-dast) и т.д.).

Хотя общепризнано, что вероятность преднамеренного внедрения вредоносного кода третьей стороной невелика, все еще существуют случаи вредоносных внедрений в сторонний код после того, как серверы организации были скомпрометированы (например, Yahoo, январь 2014 г.).

Поэтому этот риск все еще следует оценивать, в частности, когда третья сторона не предъявляет никаких документов, подтверждающих, что она применяет более эффективные меры безопасности, чем сама запрашивающая организация, или, по крайней мере, эквивалентные им. Другой пример - срок действия домена, на котором размещен сторонний JavaScript-код, истекает из-за того, что обслуживающая его компания обанкротилась или разработчики отказались от проекта. Злоумышленник может перерегистрировать домен и опубликовать вредоносный код.

Типичные средства защиты включают, но не ограничиваются ими:

- Собственное зеркальное отображение скрипта (для предотвращения изменений третьими лицами),
- [Целостность подресурса](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity) (для обеспечения перехвата на уровне браузера),
- Безопасная передача кода третьей стороны (для предотвращения изменений во время транспортировки) и различные виды изолированной защиты. Более подробную информацию смотрите ниже.
- ...

### Риск 3: Разглашение конфиденциальной информации третьим лицам

Когда на веб-сайте/в приложении вызывается сторонний скрипт, браузер напрямую связывается со сторонними серверами. По умолчанию запрос содержит все обычные HTTP-заголовки. В дополнение к исходному IP-адресу браузера, третья сторона также получает другие данные, такие как ссылка (в запросах, отличных от https) и любые файлы cookie, ранее установленные третьей стороной, например, при посещении веб-сайта другой организации, который также запускает сторонний скрипт.

Во многих случаях это предоставляет сторонним организациям первичный доступ к информации о пользователях/заказчиках организации. Кроме того, если сторонняя организация совместно использует скрипт с другими объектами, она также собирает вторичные данные от всех других объектов, таким образом, узнавая, кто является посетителями организации, а также с какими другими организациями они взаимодействуют.

Типичным примером является текущая ситуация с крупными новостными сайтами/ прессой, которые используют сторонний код (обычно для рекламных систем, статистики и API JavaScript): любой пользователь, посещающий любой из этих веб-сайтов, также сообщает третьим лицам о своем посещении. Во многих случаях третья сторона также получает информацию о том, на какие новостные статьи конкретно нажимает каждый отдельный пользователь (утечка происходит через поле HTTP-ссылки), и, таким образом, может создать более глубокие профили личности.

Типичные средства защиты включают, но не ограничиваются ими: зеркальное отображение собственных скриптов (для предотвращения утечки HTTP-запросов третьим лицам). Пользователи могут уменьшить свое профилирование, случайным образом переходя по ссылкам на веб-сайтах/приложениях с утечкой (например, на сайтах прессы/ новостных сайтах), чтобы уменьшить профилирование. Смотрите ниже для получения более подробной информации.

## Архитектуры развертывания JavaScript сторонних разработчиков

Существует три основных механизма развертывания **тегов**. Эти механизмы можно комбинировать друг с другом.

### JavaScript поставщика на странице

В этом случае поставщик предоставляет хосту JavaScript, а хост размещает его на странице хостинга. Для обеспечения безопасности хостинговая компания должна проверить код на наличие уязвимостей, таких как [XSS-атаки](https://owasp.org/www-community/attacks/xss/), или вредоносных действий, таких как отправка конфиденциальных данных из DOM на вредоносный сайт. Это часто бывает сложно, потому что JavaScript обычно запутан.

```html
<!-- Какой-нибудь хостинг, например foobar.com, HTML-код здесь -->
<html>
<head></head>
    <body>
        ...
        <script type="text/javascript">/* javascript стороннего поставщика здесь*/</script>
    </body>
</html>
```

### JavaScript-запрос к поставщику

Это когда одна или несколько строк кода на главной странице запрашивают файл JavaScript или URL-адрес непосредственно с сайта поставщика. При создании главной страницы разработчик включает строки кода, предоставленные поставщиком, которые будут запрашивать JavaScript поставщика. При каждом обращении к странице на сайт поставщика отправляются запросы на javascript, которые затем выполняются в браузере пользователя.

```html
<!-- Какой-нибудь хостинг, например foobar.com, HTML-код здесь -->`
<html>
    <head></head>
    <body>
        ...
        <!-- avascript стороннего поставщика -->
        <script src="https://analytics.vendor.com/v1.1/script.js"></script>
        <!-- /avascript стороннего поставщика -->
    </body>
</html>
```

### Косвенный запрос поставщику через диспетчер тегов

Это когда одна или несколько строк кода на главной странице запрашивают файл JavaScript или URL-адрес с сайта агрегатора тегов или **менеджера тегов**, а не с сайта поставщика JavaScript. Веб-сайт tag aggregator или tag manager возвращает любые сторонние файлы JavaScript, которые хостинговая компания настроила для возврата. Каждый запрос файла или URL-адреса на веб-сайт tag manager может возвращать множество других файлов JavaScript от нескольких поставщиков.

Фактический контент, возвращаемый агрегатором или менеджером (т.е. конкретные файлы JavaScript, а также то, что именно они делают), может динамически изменяться сотрудниками хост-сайта с помощью графического пользовательского интерфейса для разработки, размещенного на сайте менеджера тегов, с которым могут работать нетехнические пользователи, такие как маркетологи. это часть бизнеса.

Изменения могут быть следующими:

1. Получите другой JavaScript-файл от стороннего поставщика для того же запроса.
2. Измените, какие данные объекта DOM считываются и когда отправляются поставщику.

Пользовательский интерфейс разработчика tag manager сгенерирует код, который выполняет то, что требуется для маркетинговых функций, в основном определяя, какие данные следует получать из DOM браузера и когда их получать. Диспетчер тегов всегда возвращает браузеру JavaScript-файл-контейнер, который по сути представляет собой набор функций JavaScript, которые используются кодом, сгенерированным пользовательским интерфейсом, для реализации требуемой функциональности.

Подобно фреймворкам java, которые предоставляют разработчику функции и глобальные данные, контейнерный JavaScript выполняется в браузере и позволяет бизнес-пользователю использовать пользовательский интерфейс разработчика менеджера тегов для определения функциональности высокого уровня без необходимости знать JavaScript.

```html
<!-- Какой-нибудь хостинг, например foobar.com, HTML-код здесь -->
 <html>
   <head></head>
     <body>
       ...
       <!-- Tag Manager -->
       <script>(function(w, d, s, l, i){
         w[l] = w[l] || [];
         w[l].push({'tm.start':new Date().getTime(), event:'tm.js'});
         var f = d.getElementsByTagName(s)[0],
         j = d.createElement(s),
         dl = l != 'dataLayer' ? '&l=' + l : '';
         j.async=true;
         j.src='https://tagmanager.com/tm.js?id=' + i + dl;
         f.parentNode.insertBefore(j, f);
       })(window, document, 'script', 'dataLayer', 'TM-FOOBARID');</script>
       <!-- /Tag Manager -->
   </body>
</html>`
```

#### Проблемы с безопасностью при запросе тегов

Ранее описанные механизмы сложно обезопасить, потому что вы можете увидеть код, только если вы передаете запросы через прокси или если вы получаете доступ к графическому интерфейсу и видите, что настроено. JavaScript, как правило, запутан, поэтому даже просмотр его обычно бесполезен. Он также может быть мгновенно развернут, поскольку каждый запрос новой страницы из браузера выполняет запросы к агрегатору, который получает JavaScript от стороннего поставщика. Таким образом, как только какие-либо файлы JavaScript изменяются у поставщика или в агрегаторе, при следующем обращении к ним из любого браузера будет получен измененный JavaScript. Одним из способов управления этим риском является стандарт *целостности подресурса*, описанный ниже.

### Уровень прямых данных сервера (Server Direct Data Layer)

Пользовательский интерфейс разработчика tag manager можно использовать для создания JavaScript, который может получать данные из любой точки DOM браузера и сохранять их в любом месте страницы. Это может привести к появлению уязвимостей, поскольку интерфейс может использоваться для генерации кода для получения неподтвержденных данных из DOM (например, параметров URL) и сохранения их в некотором расположении страницы, которое будет выполнять JavaScript.

Лучший способ обеспечить безопасность сгенерированного кода - ограничить его получением данных DOM с уровня данных, определенного хостом.

Уровень данных - это либо:

1. объект DIV со значениями атрибутов, которые содержат маркетинговые данные или данные о поведении пользователя, необходимые третьей стороне
2. набор объектов JSON с одинаковыми данными. Каждая переменная или атрибут содержит значение некоторого элемента DOM или описание действия пользователя. Уровень данных - это полный набор значений, необходимых всем поставщикам для этой страницы. Уровень данных создается разработчиками хостинга.

Когда происходят определенные события, определенные компанией, обработчик JavaScript для этого события отправляет значения из уровня данных непосредственно на сервер диспетчера тегов. Сервер диспетчера тегов затем отправляет данные любой третьей стороне или сторонам, которые должны их получить. Код обработчика событий создается разработчиками хостинга с использованием пользовательского интерфейса разработчика tag manager. Код обработчика событий загружается с серверов tag manager при каждой загрузке страницы.

**Это безопасный метод**, поскольку в браузере пользователя выполняется только ваш JavaScript, и поставщику отправляются только те данные, которые вы выберете сами.

Это требует сотрудничества между хостом, агрегатором или менеджером тегов и поставщиками.

Разработчики хоста должны работать с поставщиком, чтобы знать, какие данные нужны поставщику для проведения анализа. Затем программист хоста определяет, какой элемент DOM будет содержать эти данные.

Разработчики хостинга должны работать с менеджером тегов или агрегатором, чтобы согласовать протокол отправки данных в агрегатор: какой URL, параметры, формат и т.д.

Менеджер тегов или агрегатор должен работать с поставщиком, чтобы согласовать протокол отправки данных поставщику: какой URL, параметры, формат и т.д. Есть ли у поставщика API?

## Соображения безопасности и обороны

### Уровень прямых данных сервера (Server Direct Data Layer)

Механизм server direct является хорошим стандартом безопасности для стороннего управления, развертывания и выполнения JavaScript. Хорошей практикой для главной страницы является создание уровня данных из DOM-объектов.

Уровень данных может выполнять любую проверку значений, особенно значений из DOM-объектов, доступных пользователю, таких как параметры URL и поля ввода, если они требуются для маркетингового анализа.

Примером утверждения для корпоративного стандартного документа является "Тег JavaScript может обращаться только к значениям на уровне данных хоста. Тег JavaScript никогда не сможет получить доступ к параметру URL.

Вы, разработчик главной страницы, должны согласовать со сторонними поставщиками или менеджером тегов, какой атрибут на уровне данных будет иметь какое значение, чтобы они могли создать JavaScript для считывания этого значения.

Теги пользовательского интерфейса невозможно защитить с помощью архитектуры уровня данных, поскольку их функция (или одна из их функций) заключается в изменении пользовательского интерфейса на клиенте, а не в отправке данных о действиях пользователя.

Теги аналитики могут быть защищены с помощью архитектуры уровня данных, поскольку единственное необходимое действие - это отправка данных с уровня данных третьей стороне. Выполняется только исходный код; сначала заполняется слой данных (обычно при загрузке страницы); затем обработчик событий JavaScript отправляет все необходимые данные с этой страницы в стороннюю базу данных или диспетчер тегов.

Это также очень масштабируемое решение. Крупные сайты электронной коммерции могут легко содержать сотни тысяч комбинаций URL-адресов и параметров, при этом различные наборы URL-адресов и параметров могут быть включены в различные маркетинговые аналитические кампании. Маркетинговая логика может содержать 30 или 40 различных тегов поставщиков на одной странице.

Например, действия пользователя на страницах, посвященных указанным городам, из указанных местоположений в указанные дни должны отправлять элементы уровня данных 1, 2 и 3. Действия пользователя на страницах, посвященных другим городам, должны отправлять только элементы уровня данных 2 и 3. Поскольку код обработчика событий для отправки данных уровня данных на каждой странице контролируется разработчиками хостинга или специалистами по маркетингу с помощью интерфейса разработчика tag manager, бизнес-логика о том, когда и какие элементы уровня данных отправляются на сервер tag manager, может быть изменена и развернута за считанные минуты. Никакого взаимодействия с третьими лицами не требуется; они по-прежнему получают ожидаемые данные, но теперь они поступают из разных контекстов, выбранных специалистами по маркетингу хостинга.

Смена сторонних поставщиков означает просто изменение правил распространения данных на сервере tag manager, никаких изменений в коде хостинга не требуется. Данные также поступают напрямую только в диспетчер тегов, что обеспечивает быстрое выполнение. Обработчику событий JavaScript не нужно подключаться к нескольким сторонним сайтам.

### Косвенные запросы

Для косвенных запросов к сайтам-менеджерам тегов/агрегаторам, которые предлагают графический интерфейс для настройки javascript, они также могут реализовывать:

- Технические средства управления, такие как разрешение JavaScript доступа только к значениям уровня данных, без использования других элементов DOM
- Ограничение типов тегов, используемых на хост-сайте, например, отключение пользовательских HTML-тегов и кода JavaScript

Принимающая компания также должна проверить методы обеспечения безопасности сайта tag manager, такие как контроль доступа к конфигурации тегов для принимающей компании. Это также может быть двухфакторная аутентификация.

Предоставление маркетологам возможности самим решать, где брать нужные им данные, может привести к появлению XSS, поскольку они могут получить их из параметра URL и поместить в переменную, которая находится в доступном для скриптов месте на странице.

### Содержимое песочницы

Оба этих инструмента могут использоваться сайтами для изолирования / очистки данных DOM.

- [DOMPurify](https://github.com/cure53/DOMPurify) - это быстрое и толерантное средство очистки XSS для HTML, MathML и SVG. DOMPurify работает с защищенным кодом по умолчанию, но предлагает множество возможностей настройки и перехватов.
- [MentalJS](https://github.com/hackvertor/MentalJS) - это синтаксический анализатор JavaScript и изолированная среда. Он позволяет отображать код JavaScript, добавляя суффикс "$" к переменным и средствам доступа.

### Целостность субресурса

[Целостность субресурса](https://www.w3.org/TR/SRI/) гарантирует, что будет выполнен только проверенный код. Разработчик генерирует метаданные целостности для javascript поставщика и добавляет их в элемент script следующим образом:

```javascript
<script src="https://analytics.vendor.com/v1.1/script.js"
   integrity="sha384-MBO5IDfYaE6c6Aao94oZrIOiC7CGiSNE64QUbHNPhzk8Xhm0djE6QqTpL0HzTUxk"
   crossorigin="anonymous">
</script>
```

Важно знать, что для работы SRI на хосте поставщика должен быть включен [CORS](https://www.w3.org/TR/cors/). Также рекомендуется регулярно отслеживать изменения в JavaScript поставщика. Потому что иногда вы можете получить **безопасный**, но **не работающий** сторонний код, когда поставщик решает обновить его.

### Поддержание в актуальном состоянии библиотек JavaScript

[OWASP Top 10 2013 A9](https://wiki.owasp.org/index.php/Top_10_2013-A9-Using_Components_with_Known_Vulnerabilities) описывает проблему использования компонентов с известными уязвимостями. Сюда входят библиотеки JavaScript. Библиотеки JavaScript необходимо постоянно обновлять, поскольку в предыдущей версии могли быть известные уязвимости, которые могут привести к тому, что сайт, как правило, будет уязвим для [межсайтового скриптинга] (https://owasp.org/www-community/attacks/xss/). Существует несколько инструментов, которые могут помочь идентифицировать такие библиотеки. Одним из таких инструментов является бесплатный инструмент с открытым исходным кодом [RetireJS](https://retirejs.github.io)

### Песочница с помощью iframe

Вы также можете поместить JavaScript поставщика в iframe из другого домена (например, из хостинга статических данных). Это будет работать как "тюрьма", и JavaScript поставщика не будет иметь прямого доступа к DOM страницы хостинга и файлам cookie.

Главная страница хоста и iframe изолированной среды могут взаимодействовать друг с другом с помощью [механизма отправки сообщений](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage).

Кроме того, iframe могут быть защищены с помощью iframe [атрибута песочницы](http://www.html5rocks.com/en/tutorials/security/sandboxed-iframes/).

Для приложений с высокой степенью риска рекомендуется использовать [Политику защиты содержимого (CSP)](https://www.w3.org/TR/CSP2/) в дополнение к изолированной среде iframe. CSP еще больше повышает защиту от XSS.

```html
<!-- Какой-нибудь хостинг, например somehost.com, HTML-код здесь -->
 <html>
   <head></head>
     <body>
       ...
       <!-- Включите iframe с помощью javascript стороннего производителя -->
       <iframe
       src="https://somehost-static.net/analytics.html"
       sandbox="allow-same-origin allow-scripts">
       </iframe>
   </body>
 </html>

<!-- somehost-static.net/analytics.html -->
 <html>
   <head></head>
     <body>
       ...
       <script>
       window.addEventListener("message", receiveMessage, false);
       function receiveMessage(event) {
         if (event.origin !== "https://somehost.com:443") {
           return;
         } else {
         // Создайте здесь какой-нибудь DOM и инициализируйте другой
        //данные, необходимые для получения кода третьей стороны
         }
       }
       </script>
       <!-- сторонний поставщик javascript -->
       <script src="https://analytics.vendor.com/v1.1/script.js"></script>
       <!-- /сторонний поставщик javascript -->
   </body>
 </html>
```

### Сдерживание виртуального iframe

Этот метод создает фреймы, которые запускаются асинхронно по отношению к главной странице. Он также предоставляет собственный JavaScript-код, который автоматизирует динамическую реализацию защищенных IFRAME-файлов на основе требований к маркетинговым тегам.

### Соглашения с поставщиками

Для заключения соглашения или запроса предложений с третьими сторонами могут потребоваться доказательства того, что они внедрили безопасное кодирование и общую защиту доступа к корпоративному серверу. Но, в частности, вам необходимо определить порядок мониторинга и контроля их исходного кода, чтобы предотвратить и обнаружить вредоносные изменения в этом JavaScript.

## MarTechSec

Marketing Technology Security (Безопасность маркетинговых технологий)

Это относится ко всем аспектам снижения риска, связанного с маркетингом JavaScript. Средства контроля включают

1. Контрактный контроль для снижения рисков; контракты с любой компанией MarTech должны включать требование о предоставлении доказательств безопасности кода и мониторинге целостности кода.
2. Контрактный контроль для передачи рисков: контракты с любой компанией MarTech могут предусматривать штраф за использование вредоносного JavaScript
3. Технические средства контроля для предотвращения выполнения вредоносного JavaScript; Виртуальные фреймы,
4. Технические средства контроля для идентификации вредоносного JavaScript; [Целостность подресурса](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity).
5. Технический контроль, включая вредоносное поведение JavaScript на стороне клиента в соответствии с требованиями тестирования на проникновение.

## MarSecOps

Marketing Security Operations (Маркетинговые операции по обеспечению безопасности)

Это относится к эксплуатационным требованиям по поддержанию некоторых технических средств контроля. Это предполагает возможное сотрудничество и обмен информацией между маркетинговой командой, поставщиком martech и командой запуска или эксплуатации для обновления информации в элементах управления страницами (изменение хэша SRI, изменения на страницах с помощью SRI), политик в виртуальных iFrames, конфигурации менеджера тегов, изменений уровня данных и т.д.

Наиболее полным и превентивным средством контроля для любого сайта, содержащего нетривиальные маркетинговые теги, являются -

1. Уровень данных, который вызывает API маркетингового сервера или диспетчера тегов, чтобы на вашей странице выполнялся только ваш код (инверсия управления).

2. [Целостность субресурса](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity).

3. Защита виртуального фрейма.

Требования MarSecOps к внедрению технических средств контроля со скоростью изменений, требуемой маркетингом, или без значительного количества выделенных ресурсов могут сделать контроль целостности уровня данных и подресурсов непрактичным.

## Ссылки на литературу

- [Widespread XSS Vulnerabilities in Ad Network Code Affecting Top Tier Publishers, Retailers](https://randywestergren.com/widespread-xss-vulnerabilities-ad-network-code-affecting-top-tier-publishers-retailers/).
- [Inside and Beyond Ticketmaster: The Many Breaches of Magecart](https://www.riskiq.com/blog/labs/magecart-ticketmaster-breach/).
- [Magecart – a malicious infrastructure for stealing payment details from online shops](https://www.clearskysec.com/magecart/).
- [Compromised E-commerce Sites Lead to "Magecart"](https://www.riskiq.com/blog/labs/magecart-keylogger-injection/)
- [Inbenta, blamed for Ticketmaster breach, admits it was hacked](https://www.zdnet.com/article/inbenta-blamed-for-ticketmaster-breach-says-other-sites-not-affected/).
