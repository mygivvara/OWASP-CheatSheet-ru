# Шпаргалка для виртуального исправления ошибок

## Вступление

Цель этой шпаргалки - представить краткую структуру виртуальных исправлений, которой организации могут следовать для максимально своевременного внедрения мер защиты от последствий.

## Определение: Виртуальное внесение исправлений

**Уровень обеспечения соблюдения политики безопасности, который предотвращает попытку использования известной уязвимости и сообщает о ней.**

Виртуальное исправление работает, когда уровень обеспечения безопасности анализирует транзакции и перехватывает атаки в процессе передачи, поэтому вредоносный трафик никогда не достигает веб-приложения. В результате виртуальное исправление приводит к тому, что, хотя исходный код самого приложения не был изменен, попытка его использования не увенчалась успехом.

## Почему бы просто не исправить код

С чисто технической точки зрения, стратегия устранения уязвимости номер один для организации заключается в устранении выявленной уязвимости в исходном коде веб-приложения. С этой концепцией согласны как эксперты по безопасности веб-приложений, так и владельцы систем. К сожалению, в реальных бизнес-ситуациях возникает множество сценариев, в которых обновление исходного кода веб-приложения является непростой задачей, например:

- **Нехватка ресурсов** - Разработчики уже задействованы в других проектах.
- **Программное обеспечение сторонних производителей** - Код не может быть изменен пользователем.
- **Разработка приложений на стороне** - Для внесения изменений потребуется новый проект.

Важным моментом является то, что **исправления на уровне кода и виртуальные исправления не являются взаимоисключающими**. Это процессы, которые выполняются разными командами (OWASP Builders/Devs vs. OWASP Defenders/OpSec) и могут быть запущены в тандеме.

## Ценность виртуального исправления

Двумя основными целями виртуального исправления являются:

- **Минимизируйте время на исправление** - Исправление исходного кода приложения требует времени. Основная цель виртуального исправления - как можно скорее устранить выявленную уязвимость. Срочность такого реагирования может быть разной: например, если уязвимость была выявлена собственными силами с помощью анализа кода или тестирования на проникновение, а не путем обнаружения уязвимости в рамках оперативного реагирования на инцидент.
- **Уменьшение площади атаки** - Сосредоточьтесь на минимизации вектора атаки. В некоторых случаях, например, при отсутствии положительной проверки входных данных системы безопасности, можно добиться 100% уменьшения площади атаки. В других случаях, например, при отсутствии кодировки на выходе из-за ошибок XSS, вы можете ограничить экспозицию. Имейте в виду, что 50%-ное сокращение за 10 минут лучше, чем 100%-ное сокращение за 48 часов.

## Инструменты для внесения виртуальных исправлений

Обратите внимание, что в приведенном выше определении не перечислен какой-либо конкретный инструмент, поскольку существует ряд различных опций, которые могут быть использованы для виртуального исправления, таких как:

- Промежуточные устройства, такие как WAF или IPS-устройства
- Подключаемый модуль веб-сервера, такой как ModSecurity
- Фильтр прикладного уровня, такой как ESAPI WAF

В качестве примера мы покажем примеры виртуального исправления с использованием открытого исходного кода [ModSecurity WAF tool](http://www.modsecurity.org).

## Методология виртуального исправления

К внесению виртуальных исправлений, как и к большинству других процессов обеспечения безопасности, не следует подходить бессистемно. Вместо этого следует придерживаться последовательного, повторяемого процесса, который обеспечит наилучшие шансы на успех. Следующий рабочий процесс внесения виртуальных исправлений имитирует принятую в отрасли практику реагирования на ИТ-инциденты и состоит из следующих этапов:

1. Подготовка.
2. Идентификация.
3. Анализ.
4. Создание виртуального патча.
5. Внедрение/Тестирование.
6. Восстановление/Последующие действия.

## Пример публичной уязвимости

Давайте возьмем следующую [SQLi уязвимость](https://packetstormsecurity.com/files/119217/WordPress-Shopping-Cart-8.1.14-Shell-Upload-SQL-Injection.html) в качестве примера для оставшейся части этой статьи:

```text
WordPress Shopping Cart Plugin for WordPress
/wp-content/plugins/levelfourstorefront/scripts/administration/exportsubscribers.php
reqID Parameter prone to SQL Injection.
```

**Описание**:

Плагин WordPress Shopping Cart для WordPress содержит уязвимость, которая может позволить злоумышленнику осуществить атаку с помощью SQL-инъекции.

Проблема возникает из-за того, что скрипт `/wp-content/plugins/levelfourstorefront/scripts/administration/exportsubscribers.php` неправильно обрабатывал введенный пользователем параметр `reqID`.

Это может позволить злоумышленнику внедрять SQL-запросы во внутреннюю базу данных или манипулировать ими, что позволяет манипулировать произвольными данными или раскрывать их.

## Подготовительный этап

Важность правильного использования этапа подготовки к виртуальному внесению исправлений трудно переоценить. Вам необходимо выполнить ряд действий по настройке процессов и платформы виртуального исправления, **прежде** чем вам действительно придется устранять выявленную уязвимость или, что еще хуже, реагировать на вторжение веб-приложения в реальном времени. Дело в том, что во время реальной компрометации не самое подходящее время предлагать установку брандмауэра веб-приложений и концепцию виртуального исправления. Во время реальных инцидентов напряженность высока, и время имеет большое значение, поэтому заложите основу для виртуального исправления ситуации, когда ситуация спокойна, и подготовьте все к работе, когда инцидент все-таки произойдет.

Вот несколько важных моментов, на которые следует обратить внимание на этапе подготовки:

- **Общедоступный мониторинг уязвимостей/мониторинг уязвимостей поставщиков** - Убедитесь, что вы подписаны на рассылку всех уведомлений от поставщиков для коммерческого программного обеспечения, которое вы используете. Это гарантирует, что вы будете получать уведомления в случае, если поставщик опубликует информацию об уязвимостях и данные для исправления.
- **Предварительная авторизация при установке виртуальных исправлений** - Необходимо быстро внедрять виртуальные исправления, поэтому необходимо ускорить обычные процессы управления и этапы авторизации стандартных исправлений программного обеспечения. Поскольку виртуальные исправления на самом деле не изменяют исходный код, они не требуют такого же объема регрессионного тестирования, как обычные программные исправления. Отнесение виртуальных исправлений к той же группе, что и антивирусных обновлений или сетевых идентификационных подписей, помогает ускорить процесс авторизации и свести к минимуму длительные этапы тестирования.
- **Заблаговременно разверните виртуальный инструмент исправления** - Поскольку время реагирования на инциденты имеет решающее значение, получение разрешений на установку нового программного обеспечения является неподходящим моментом. Например, вы можете установить ModSecurity WAF во встроенном режиме на свои серверы Apache или на обратный прокси-сервер Apache. Преимущество этого развертывания в том, что вы можете создавать исправления для внутренних серверов, отличных от Apache. Даже если вы не используете ModSecurity в обычных условиях, лучше всего иметь его "наготове", готовым к включению в случае необходимости.
- **Расширьте ведение журнала аудита HTTP** – Стандартный формат общего журнала (CLF), используемый большинством веб-серверов, не предоставляет достаточных данных для надлежащего реагирования на инциденты. У вас должен быть доступ к следующим данным HTTP:
    - Request URI (including QUERY_STRING)
    - Full Request Headers (including Cookies)
    - Full Request Body (POST payload)
    - Full Response Headers
    - Full Response Body

## Фаза идентификации

The Identification Phase occurs when an organization becomes aware of a vulnerability within their web application. There are generally two different methods of identifying vulnerabilities: `Proactive` and `Reactive`. Этап идентификации наступает, когда организации становится известно об уязвимости в своем веб-приложении. Как правило, существует два различных метода выявления уязвимостей: `проактивный` и `реактивный`.

### Проактивная идентификация

Это происходит, когда организация берет на себя ответственность за оценку состояния своей веб-безопасности и выполняет следующие задачи:

- **Динамическая оценка приложений** - Этичные злоумышленники проводят тесты на проникновение или запускают автоматизированные инструменты веб-оценки в реальном веб-приложении для выявления недостатков.
- **Проверка исходного кода** - Этичные злоумышленники используют ручные или автоматизированные средства для анализа исходного кода веб-приложения для выявления недостатков.

В связи с тем, что веб-приложения с пользовательским кодом уникальны, эти задачи проактивной идентификации чрезвычайно важны, поскольку вы не можете полагаться на уведомления об уязвимостях от третьих лиц.

### Реактивная идентификация

Существует три основных реактивных метода выявления уязвимостей:

- **Обращение к поставщику (например, предварительное предупреждение)** - Происходит, когда поставщик раскрывает уязвимость в коммерческом веб-приложении, которое вы используете. Примером может служить [Active Protections Program (MAPP)] от Microsoft(https://www.microsoft.com/en-us/msrc/mapp).
- **Публичное раскрытие информации** - Публичное раскрытие уязвимости используемого вами коммерческого веб-приложения с открытым исходным кодом. Уровень угрозы публичного раскрытия информации повышается по мере того, как все больше людей узнают об уязвимости.
- **Инцидент с безопасностью** – Это наиболее срочная ситуация, поскольку атака активна. В таких ситуациях устранение неполадок должно быть незамедлительным.

## Фаза анализа

Вот рекомендуемые шаги для начала этапа анализа:

1. **Определение применимости виртуального исправления** - Виртуальное исправление идеально подходит для устранения дефектов типа инъекции, но может не обеспечить достаточного уровня снижения поверхности атаки для других типов или категорий атак. Необходимо провести тщательный анализ лежащего в основе дефекта, чтобы определить, обладает ли инструмент виртуального исправления адекватными логическими возможностями обнаружения.
2. **Использовать систему отслеживания ошибок/выдачи билетов** - Введите информацию об уязвимостях в систему отслеживания ошибок для целей отслеживания и определения показателей. Рекомендуем использовать уже используемые системы выдачи билетов, такие как Jira, или специализированный инструмент, такой как [ThreadFix](https://threadfix.it/).
3. **Проверьте название уязвимости** - Это означает, что вам необходимо иметь соответствующий общедоступный идентификатор уязвимости (например, имя/номер CVE), указанный в объявлении об уязвимости, при сканировании уязвимостей и т.д. Если уязвимость выявляется проактивно, а не посредством публичных объявлений, то вам следует присвоить каждой уязвимости свой собственный уникальный идентификатор.
4. **Укажите уровень воздействия** - Всегда важно понимать уровень критичности, связанный с веб-уязвимостью. Утечка информации может рассматриваться по-разному, как проблема с внедрением SQL-кода.
5. **Укажите, на какие версии программного обеспечения это влияет** - Вам необходимо указать, какие версии программного обеспечения указаны в списке, чтобы вы могли определить, затронуты ли установленные вами версии.
6. **Укажите, какая конфигурация требуется для запуска проблемы** - Некоторые уязвимости могут проявляться только при определенных настройках конфигурации.
7. **Приведите код эксплойта для проверки концепции (PoC) или полезную нагрузку, использованную во время атак/тестирования** - Многие объявления об уязвимостях сопровождаются кодом эксплойта, который показывает, как продемонстрировать уязвимость. Если эти данные доступны, обязательно загрузите их для анализа. Это будет полезно позже, при разработке и тестировании виртуального патча.

## Этап создания виртуального патча

Процесс создания точного виртуального исправления зависит от двух основных условий:

1. **Никаких ложных срабатываний** - Никогда и ни при каких обстоятельствах не блокируйте легетимный трафик.
2. **Отсутствие ложных срабатываний** - Никогда не пропускайте атаки, даже если злоумышленник намеренно пытается избежать обнаружения.

Следует позаботиться о том, чтобы свести к минимуму любое из этих двух правил. Возможно, невозможно на 100% придерживаться каждой из этих целей, но помните, что виртуальное внесение исправлений направлено на **снижение риска**. Владельцы бизнеса должны понимать, что, хотя вы получаете преимущество за счет сокращения показателя времени на устранение неполадок, вы, возможно, не полностью устраняете недостаток.

### Ручное создание виртуального патча

#### Виртуальные исправления с положительным уровнем защиты (список разрешенных) (**Рекомендуемое решение**)

Позитивная модель безопасности (allow list) - это комплексный механизм безопасности, который предоставляет приложению независимую систему проверки ввода. Модель определяет характеристики допустимого ввода (набор символов, длина и т.д.) и запрещает все, что не соответствует требованиям. Определяя правила для каждого параметра на каждой странице приложения, приложение защищается дополнительной оболочкой безопасности, независимой от его кода.

##### Пример списка разрешений ModSecurity Virtual Patch

Чтобы создать виртуальный патч со списком разрешений, вы должны иметь возможность проверить, каковы обычные ожидаемые входные значения. Если вы внедрили надлежащее ведение журнала аудита на этапе подготовки, вы должны иметь возможность просматривать журналы аудита, чтобы определить формат ожидаемых типов входных данных. В этом случае предполагается, что параметр `reqID` содержит только целые символы, поэтому мы можем использовать этот виртуальный патч:

```text
##
## Убедитесь, что мы получаем только 1 вызываемый параметр "reqID"
##
SecRule REQUEST_URI "@contains /wp-content/plugins/levelfourstorefront/scripts/administration/exportsubscribers.php" "chain,id:1,phase:2,t:none,t:Utf8toUnicode,t:urlDecodeUni,t:normalizePathWin,t:lowercase,block,msg:'Input Validation Error for \'reqID\' parameter - Duplicate Parameters Names Seen.',logdata:'%{matched_var}'"
  SecRule &ARGS:/reqID/ "!@eq 1"

##
## Убедитесь, что пейлоад reqID содержит только целые числа
##
SecRule REQUEST_URI "@contains /wp-content/plugins/levelfourstorefront/scripts/administration/exportsubscribers.php" "chain,id:2,phase:2,t:none,t:Utf8toUnicode,t:urlDecodeUni,t:normalizePathWin,t:lowercase,block,msg:'Input Validation Error for \'reqID\' parameter.',logdata:'%{args.reqid}'"
  SecRule ARGS:/reqID/ "!@rx ^[0-9]+$"
```

Этот виртуальный патч проверит значение параметра `reqID` на указанной странице и предотвратит использование любых символов, отличных от целых, в качестве входных данных.

- **Примечание** - Вы должны убедиться, что правильно присвоили идентификаторы правил и отследили их в системе отслеживания ошибок.
- **Внимание**: При создании виртуальных исправлений существует множество способов уклонения. Пожалуйста, ознакомьтесь с [документом OWASP Best Practices: Virtual Patching](https://owasp.org/www-community/Virtual_Patching_Best_Practices) для более подробного обсуждения методов противодействия уклонению.

#### Виртуальные исправления с отрицательной защитой (черынй список)

Негативная модель безопасности (denylist) основана на наборе правил, которые обнаруживают конкретные известные атаки, а не разрешают только допустимый трафик.

##### Пример списка блокировок ModSecurity Virtual Patch

Вот пример [PoC code](https://packetstormsecurity.com/files/119217/WordPress-Shopping-Cart-8.1.14-Shell-Upload-SQL-Injection.html), который был предоставлен общественным консультативным советом:

```text
http://localhost/wordpress/wp-content/plugins/levelfourstorefront/scripts/administration/exportsubscribers.php?reqID=1' or 1='1
```

Просматривая полезную нагрузку, мы видим, что злоумышленник вставляет символ одинарной кавычки, а затем добавляет дополнительную логику SQL-запроса в конец. Основываясь на этих данных, мы могли бы запретить символ одинарной кавычки следующим образом:

```text
SecRule REQUEST_URI "@contains /wp-content/plugins/levelfourstorefront/scripts/administration/exportsubscribers.php" "chain,id:1,phase:2,t:none,t:Utf8toUnicode,t:urlDecodeUni,t:normalizePathWin,t:lowercase,block,msg:'Input Validation Error for \'reqID\' parameter.',logdata:'%{args.reqid}'"
  SecRule ARGS:/reqID/ "@pm '"
```

#### Какой метод лучше подходит для виртуального исправления – положительный или отрицательный

Виртуальный патч может использовать как позитивную, так и негативную модель безопасности. Какую из них вы решите использовать, зависит от ситуации и ряда других соображений. Например, негативные правила безопасности обычно можно внедрить быстрее, однако вероятность их обхода более высока.

С другой стороны, позитивные правила безопасности обеспечивают лучшую защиту, однако часто это ручной процесс, который не масштабируется и который сложно поддерживать на больших / динамичных сайтах. Хотя ручные правила позитивной безопасности для всего сайта могут оказаться невыполнимыми, модель позитивной безопасности может быть выборочно использована, когда предупреждение об уязвимости идентифицирует конкретное местоположение с проблемой.

#### Остерегайтесь виртуальных исправлений, специфичных для эксплойтов

Вы не должны поддаваться желанию пойти по легкому пути и быстро создать **специфичный для эксплойтов виртуальный патч**.

Например, если авторизованный тест на проникновение выявил уязвимость XSS на странице и использовал в отчете следующий пейлоад для атаки:

```html
<script>
  alert('XSS Test')
</script>
```

Было бы неразумно внедрять виртуальный патч, который просто блокирует именно эту полезную нагрузку. Хотя он может обеспечить некоторую немедленную защиту, его долгосрочная ценность значительно снижается.

### Автоматическое создание виртуального патча

Создание исправлений вручную может стать невозможным по мере роста числа уязвимостей и может возникнуть необходимость в автоматизированных средствах. Если уязвимости были выявлены с помощью автоматизированных средств и доступен отчет в формате XML, можно использовать автоматизированные процессы для автоматического преобразования данных об уязвимостях в виртуальные исправления для систем защиты.

Три примера включают в себя:

- **Скрипты OWASP ModSecurity Core Rule Set (CRS)** - CRS OWASP включает в себя скрипты для автоматического преобразования выходных данных XML из таких инструментов, как [OWASP ZAP в виртуальные исправления ModSecurity]. Ссылка [здесь](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/modsecurity-advanced-topic-of-the-week-automated-virtual-patching-using-owasp-zed-attack-proxy).
- **Виртуальное исправление ThreadFix** - ThreadFix также включает автоматизированные процессы преобразования импортированных XML-данных об уязвимостях в виртуальные исправления для инструментов безопасности, таких как ModSecurity. Ссылка [здесь](https://github.com/denimgroup/threadfix/wiki/Waf-Types#mod_security).
- **Прямой импорт на устройство WAF** - Многие коммерческие продукты WAF имеют возможность импортировать данные XML-отчетов DAST tool и автоматически настраивать свои профили защиты.

## Этап внедрения/тестирования

Для точного тестирования недавно созданных виртуальных исправлений может потребоваться использование приложения, отличного от веб-браузера. Вот некоторые полезные инструменты:

- Веб-браузер.
- Веб-клиенты командной строки, такие как Curl и Wget.
- Локальные прокси-серверы, такие как [OWASP ZAP](https://www.zaproxy.org/).
- [ModSecurity AuditViewer](https://web.archive.org/web/20181011065823/http://www.jwall.org/web/audit/viewer.jsp) – который позволяет загружать файл журнала аудита ModSecurity, манипулировать им и затем повторно загружать данные обратно на любой веб-сервер.

### Этапы тестирования

- Изначально внедрите виртуальные исправления в конфигурации "Только для регистрации", чтобы гарантировать, что вы не заблокируете обычный пользовательский трафик (ложные срабатывания).
- Если уязвимость была выявлена определенным инструментом или группой оценки, запросите повторное тестирование.
- Если повторное тестирование завершилось неудачей из-за уклонений, вы должны вернуться к этапу анализа, чтобы определить, как лучше устранить проблему.

## Фаза восстановления/последующего наблюдения

- **Обновление данных в системе уведомлений** - Несмотря на то, что вам может потребоваться ускорить внедрение виртуальных исправлений, вы все равно должны отслеживать их в рамках обычных процессов управления исправлениями. Это означает, что вам следует создать соответствующие заявки на изменение и т.д., чтобы их существование и функциональность были задокументированы. Обновление системы уведомлений также помогает определить показатели "времени на исправление" для различных типов уязвимостей. Убедитесь, что вы правильно записали значения идентификатора правила виртуального исправления.
- **Периодические повторные проверки** - Вам также следует проводить периодические повторные проверки, чтобы проверить, сможете ли вы удалить предыдущие виртуальные исправления, если код веб-приложения был обновлен с исправлением реального исходного кода. Я обнаружил, что многие люди предпочитают сохранять виртуальные исправления на месте из-за лучшей идентификации / ведения журнала по сравнению с возможностями приложений или базы данных.
- **Запуск отчетов о предупреждениях о виртуальных исправлениях** - Запуск отчетов, чтобы определить, сработали ли какие-либо из ваших виртуальных исправлений. Это покажет значение виртуального исправления в зависимости от времени, необходимого для исправления исходного кода.

## Ссылки на литературу

- [OWASP Virtual Patching Best Practices](https://owasp.org/www-community/Virtual_Patching_Best_Practices).
- [OWASP Securing WebGoat with ModSecurity](https://wiki.owasp.org/index.php/Category:OWASP_Securing_WebGoat_using_ModSecurity_Project).
