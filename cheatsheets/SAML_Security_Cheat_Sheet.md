# Шпаргалка по безопасности SAML

## Вступление

Язык разметки утверждений безопасности (**S**ecurity **A**ssertion **M**arkup **L**anguage) ([SAML](https://en.wikipedia.org/wiki/Security_Assertion_Markup_Language)) является открытым стандартом для обмена информацией об авторизации и аутентификации. *Профиль SAML/SSO веб-браузера с привязками Redirect/POST* является одной из наиболее распространенных реализаций единого входа. Эта читаблица будет посвящена в первую очередь этому профилю.

## Проверка конфиденциальности и целостности сообщений

[Протокол TLS 1.2](Transport_Layer_Security_Cheat_Sheet.md) является наиболее распространенным решением, гарантирующим конфиденциальность и целостность сообщений на транспортном уровне. Дополнительную информацию см. в [SAML Security (раздел 4.2.1)](https://docs.oasis-open.org/security/saml/v2.0/saml-sec-consider-2.0-os.pdf). Этот шаг поможет противостоять следующим атакам:

- Eavesdropping 7.1.1.1
- Theft of User Authentication Information 7.1.1.2
- Theft of the Bearer Token 7.1.1.3
- Message Deletion 7.1.1.6
- Message Modification 7.1.1.7
- Man-in-the-middle 7.1.1.8

Сообщение с цифровой подписью и сертифицированным ключом является наиболее распространенным решением, гарантирующим целостность сообщения и аутентификацию. Дополнительную информацию см. в разделе [Безопасность SAML (раздел 4.3)](https://docs.oasis-open.org/security/saml/v2.0/saml-sec-consider-2.0-os.pdf). Этот шаг поможет противостоять следующим атакам:

- Man-in-the-middle 6.4.2
- Forged Assertion 6.4.3
- Message Modification 7.1.1.7

Утверждения могут быть зашифрованы с помощью XMLEnc, чтобы предотвратить раскрытие конфиденциальных атрибутов после передачи. Обратитесь к [SAML Security (раздел 4.2.2)](https://docs.oasis-open.org/security/saml/v2.0/saml-sec-consider-2.0-os.pdf) для получения дополнительной информации. Этот шаг поможет противостоять следующим атакам:

- Кража аутентификационной информации пользователя 7.1.1.2

## Проверка использования протокола

Это распространенная причина пробелов в системе безопасности - смотрите [Уязвимость единого входа в Google](https://www.kb.cert.org/vuls/id/612636/) для примера из реальной жизни. Их профиль единого входа был уязвим для атаки "Человек посередине" со стороны вредоносного SP (поставщика услуг).

Профиль веб-браузера единого входа наиболее подвержен атакам со стороны доверенных партнеров. Этот конкретный недостаток безопасности был выявлен из-за того, что ответ SAML не содержал всех необходимых элементов данных, необходимых для безопасного обмена сообщениями. Соблюдение [SAML Profile](https://docs.oasis-open.org/security/saml/v2.0/saml-profiles-2.0-os.pdf) требований к использованию AuthnRequest (4.1.4.1) и Response (4.1.4.2) поможет противостоять этой атаке.

Команда *AVANTSSAR* предложила использовать следующие элементы данных:

- **AuthnRequest(ID, SP):** `AuthnRequest` должен содержать и `ID`, и `SP`. Где `ID` - это строка, однозначно идентифицирующая запрос, а `SP` - `Service Provider`, который инициировал запрос. Кроме того, в ответе должен быть возвращен атрибут запроса `ID` (`InResponseTo="<Идентификатор запроса>"`). `InResponseTo` помогает гарантировать подлинность ответа от доверенного IDP. Это был один из недостающих атрибутов, который делал единый вход Google уязвимым.
- **Response(ID, SP, IdP, {AA} K -1/IdP):** Ответ должен содержать все эти элементы. Где `ID` - это строка, однозначно идентифицирующая ответ. `SP` идентифицирует получателя ответа. `IdP` идентифицирует поставщика идентификационных данных, авторизующего ответ. `{AA} K -1/IdP` - это утверждение, подписанное цифровой подписью с помощью закрытого ключа `IdP`.
- **Auth Assert(ID, C, IdP, SP):** В ответе должно содержаться подтверждение аутентификации. Он должен содержать `ID`, идентификатор клиента `(C)`, поставщика идентификационных данных `(IdP)` и поставщика услуг `(SP)`.

### Проверка подлинности сигнатур

Уязвимости в реализациях SAML, связанные с атаками на перенос подписи XML, были описаны в 2012 году [О взломе SAML: Будь тем, кем хочешь быть](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91-8-23-12.pdf).

В ответ были предложены следующие рекомендации ([Безопасная проверка SAML для предотвращения атак на перенос подписи XML](https://arxiv.org/pdf/1401.7483v1.pdf)):

- Всегда выполняйте проверку схемы в XML-документе, прежде чем использовать его для любых целей, связанных с безопасностью:
    - Всегда используйте локальные, надежные копии схем для проверки.
    - Никогда не разрешайте автоматическую загрузку схем из сторонних хранилищ.
    - Если возможно, проверьте схемы и выполните их упрочнение, чтобы отключить возможные шаблонные типы или упрощенные инструкции по обработке.
- Надежная проверка цифровой подписи:
    - Если вы ожидаете получить только один ключ подписи, используйте `StaticKeySelector`. Получите ключ непосредственно у поставщика удостоверений, сохраните его в локальном файле и игнорируйте любые элементы `KeyInfo` в документе.
    - Если вы ожидаете получить более одного ключа подписи, используйте `X509KeySelector` (вариант JKS). Получите эти ключи напрямую от поставщиков удостоверений, сохраните их в локальном JKS и игнорируйте любые элементы `KeyInfo` в документе.
    - Если вы ожидаете получить разнородные подписанные документы (множество сертификатов от многих поставщиков удостоверений, многоуровневые пути проверки), внедрите модель установления полного доверия, основанную на PKIX и доверенных корневых сертификатах.
- Избегайте атак с использованием переноса подписи.
    - Никогда не используйте `getElementsByTagName` для выбора элементов, связанных с безопасностью, в XML-документе без предварительной проверки.
    - Всегда используйте абсолютные выражения XPath для выбора элементов, если только для проверки не используется строгая схема.

## Проверка правил обработки протоколов

Это еще одна распространенная область пробелов в системе безопасности просто из-за огромного количества шагов, требующих подтверждения.

Обработка ответа SAML является дорогостоящей операцией, но все шаги должны быть проверены:

- Проверка правил обработки запросов AuthnRequest. Все правила обработки запросов AuthnRequest приведены в [SAML Core](https://docs.oasis-open.org/security/saml/v2.0/saml-core-2.0-os.pdf) (3.4.1.4). Этот шаг поможет противостоять следующим атакам:
    - Man-in-the-middle (6.4.2)
- Проверка правил обработки ответов. Все правила обработки ответов приведены в [SAML Profiles](https://docs.oasis-open.org/security/saml/v2.0/saml-profiles-2.0-os.pdf) (4.1.4.3). Этот шаг поможет противостоять следующим атакам:
    - Stolen Assertion (6.4.1)
    - Man-in-the-middle (6.4.2)
    - Forged Assertion (6.4.3)
    - Browser State Exposure (6.4.4)

## Проверка реализации привязки

- Для привязки HTTP-перенаправления обратитесь к [Привязке SAML](https://docs.oasis-open.org/security/saml/v2.0/saml-bindings-2.0-os.pdf) (3.4). Чтобы просмотреть пример кодировки, вы можете перейти по ссылке RequestUtil.java, найденной в [справочной реализации Google](https://developers.google.com/google-apps/sso/saml_reference_implementation_web).
- Для привязки HTTP POST обратитесь к [Привязке SAML](https://docs.oasis-open.org/security/saml/v2.0/saml-bindings-2.0-os.pdf) (3.5). Вопросы кэширования также очень важны. Если сообщение протокола SAML попадает в кэш, оно впоследствии может быть использовано в качестве атаки с использованием украденного утверждения (6.4.1) или повторного воспроизведения (6.4.5).

## Проверка правильности контрмер безопасности

Просмотрите каждую угрозу безопасности, которая существует в документе [SAML Security](https://docs.oasis-open.org/security/saml/v2.0/saml-sec-consider-2.0-os.pdf), и убедитесь, что вы применили соответствующие меры противодействия угрозам, которые могут существовать в вашей конкретной реализации.

К дополнительным мерам противодействия, которые следует рассмотреть, относятся:

- При необходимости предпочитайте фильтрацию по IP. Например, эта мера могла бы предотвратить первоначальную уязвимость Google в системе безопасности, если бы Google предоставила каждому доверенному партнеру отдельную конечную точку и настроила IP-фильтр для каждой конечной точки. Этот шаг поможет противостоять следующим атакам:
    - Stolen Assertion (6.4.1)
    - Man-in-the-middle (6.4.2)
- Предпочитайте короткие сроки действия ответа SAML. Этот шаг поможет противостоять следующим атакам:
    - Stolen Assertion (6.4.1)
    - Browser State Exposure (6.4.4)
- Предпочтите однократное использование SAML-ответа. Этот шаг поможет противостоять следующим атакам:
    - Browser State Exposure (6.4.4)
    - Replay (6.4.5)

Нужна архитектурная схема? В [SAML technical overview](https://www.oasis-open.org/committees/download.php/11511/sstc-saml-tech-overview-2.0-draft-03.pdf) содержатся наиболее полные схемы. Для получения информации о профиле единого входа в веб-браузер с привязками перенаправления/ПУБЛИКАЦИИ обратитесь к разделу 4.1.3. Фактически, из всей документации SAML технический обзор является наиболее ценным с точки зрения высокого уровня.

## Незапрашиваемый ответ (т.е. Единый вход, инициированный IDP) Рекомендации для поставщиков услуг

Незапрашиваемый ответ по своей сути [менее безопасен](https://www.identityserver.com/articles/the-dangers-of-saml-idp-initiated-sso) по замыслу из-за отсутствия защиты [CSRF](https://owasp.org/www-community/attacks/csrf). Однако многие поддерживают его благодаря функции обратной совместимости SAML 1.1. Общая рекомендация по безопасности - не поддерживать этот тип аутентификации, но если она должна быть включена, следующие шаги (в дополнение ко всему, что упомянуто выше) должны помочь вам обезопасить этот поток:

- Следуйте процедуре проверки, описанной в [SAML-профилях (раздел 4.1.5)](https://docs.oasis-open.org/security/saml/v2.0/saml-profiles-2.0-os.pdf). Этот шаг поможет противостоять следующим атакам:
    - Воспроизведение (6.1.2)
    - Вставка сообщения (6.1.3)
- Если в параметре `RelayState` указан URL-адрес, убедитесь, что URL-адрес проверен и явно включен в список разрешений. Этот шаг поможет отразить следующую атаку:
    - [Открыть Redirect](https://cheatsheetseries.owasp.org/cheatsheets/Unvalidated_Redirects_and_Forwards_Cheat_Sheet.html)
- Реализуйте правильное обнаружение повтора либо на уровне ответа, либо на уровне утверждения. Это поможет отразить следующую атаку:
    - Повтор (6.1.2)

## Сооображения касающиеся поставщика идентификационных данных и поставщика услуг

Протокол SAML редко является предпочтительным, хотя важно иметь шпаргалки, чтобы убедиться в его надежности. Различные конечные точки более целенаправленны, поэтому на практике важно, как генерируется токен SAML и как он используется.

### Соображения, касающиеся поставщика идентификационных данных (IdP)

- Проверка сертификата X.509 на совместимость с алгоритмами, надежность шифрования, экспортные ограничения
- Проверка параметров надежной аутентификации для генерации токена SAML
- Проверка IDP (при которой IDP чеканит токен)
- По возможности используйте корневые центры сертификации/доверяйте им
- Синхронизация с общим источником времени в Интернете
- Определение уровней надежности для проверки личности
- Предпочтение асимметричных идентификаторов при подтверждении личности перед информацией, позволяющей установить личность (например, SSN и т.д.)
- Подписывайте каждое отдельное утверждение или весь элемент ответа

### Соображения, касающиеся поставщика услуг (SP)

- Проверка состояния сеанса для пользователя
- Степень детализации при настройке контекста авторизации при использовании токена SAML (используете ли вы группы, роли, атрибуты)
- Убедитесь, что каждое утверждение или весь элемент ответа подписан
- [Проверяйте сигнатуры](#проверка-подлинности-сигнатур)
- Проверить, подписан ли IDP авторизованным пользователем
- Проверить сертификаты IDP на истечение срока действия и аннулирование в соответствии с CRL/OCSP
- Проверить NotBefore и NotOnOrAfter
- Проверить атрибут получателя
- Определить критерии для выхода из SAML
- Обмениваться утверждениями только по защищенным каналам передачи
- Определение критериев для управления сеансами
- По возможности проверяйте идентификационные данные пользователей, полученные из утверждений SAML ticket.

## Проверка правильности введенных данных

Тот факт, что SAML является протоколом безопасности, не означает, что проверка входных данных отменяется.

- Убедитесь, что все поставщики/потребители SAML выполняют надлежащую [проверку входных данных](Input_Validation_Cheat_Sheet.md).

## Криптография

Решения, основанные на криптографических алгоритмах, должны соответствовать последним достижениям в области криптоанализа.

- Убедитесь, что все элементы SAML в цепочке используют [надежное шифрование](Cryptographic_Storage_Cheat_Sheet.md#алгоритмы)
- Рассмотрите возможность отмены поддержки [небезопасных алгоритмов XML](https://www.w3.org/TR/xmlenc-core1/#sec-RSA-1_5)
