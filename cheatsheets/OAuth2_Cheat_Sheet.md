# Таблица рекомендаций по протоколу OAuth 2.0

В этой таблице описываются лучшие современные методы обеспечения безопасности [1] для OAuth 2.0, основанные на его RFC [2][3]. OAuth стал стандартом защиты API и основой для федеративного входа в систему с использованием OpenID Connect. OpenID Connect 1.0 - это простой уровень идентификации поверх протокола OAuth 2.0. Это позволяет клиентам проверять личность конечного пользователя на основе аутентификации, выполняемой сервером авторизации, а также получать основную информацию о профиле конечного пользователя совместимым и REST-подобным образом.

## Терминология

- Токены доступа = предоставляют абстракцию, заменяющую различные конструкции авторизации (например, имя пользователя и пароль, утверждение) на один токен, понятный серверу ресурсов. Эта абстракция позволяет выдавать токены доступа, действительные в течение короткого периода времени, а также избавляет сервер ресурсов от необходимости разбираться в широком спектре схем аутентификации.
- Токены обновления = это учетные данные, используемые для получения токенов доступа. Они выдаются клиенту сервером авторизации и используются для получения нового токена доступа, когда текущий токен доступа становится недействительным или истекает срок его действия, или для получения дополнительных токенов доступа с идентичной или более узкой областью действия (токены доступа могут иметь меньший срок службы и меньше разрешений, чем разрешено владельцем ресурса).
- Клиент = обычно относится к приложению, отправляющему запросы к защищенным ресурсам от имени владельца ресурса и с его разрешения. Термин "клиент" не подразумевает каких-либо конкретных характеристик реализации (например, независимо от того, выполняется ли приложение на сервере, настольном компьютере или других устройствах).
- Сервер авторизации (AS) = относится к серверу, выдающему токены доступа клиенту после успешной аутентификации владельца ресурса и получения авторизации.
- Владелец ресурса (RO) = относится к организации, способной предоставлять доступ к защищенному ресурсу. Если владельцем ресурса является физическое лицо, оно называется конечным пользователем.
- Сервер ресурсов (RS) = относится к серверу, на котором размещены защищенные ресурсы, способный принимать запросы на защищенные ресурсы и отвечать на них с использованием токенов доступа.

## Основные принципы OAuth 2.0

1. Клиенты и сервер авторизации не должны предоставлять URL-адреса, которые перенаправляют браузер пользователя на произвольные URI, полученные из параметра запроса ("открытые перенаправители"), который может обеспечить фильтрацию кодов авторизации и токенов доступа.
2. Клиенты убедились, что сервер авторизации, поддерживающий PKCE, может полагаться на защиту CRSF, предоставляемую PKCE. В потоках OpenID Connect параметр "nonce" обеспечивает защиту CSRF. В противном случае для защиты CSRF необходимо использовать одноразовые пользовательские токены CSRF, переданные в параметре "state", которые надежно привязаны к пользовательскому агенту.
3. Когда клиент OAuth может взаимодействовать с несколькими серверами авторизации, клиенты должны использовать параметр iss "issuer" в качестве контрмеры или на основе значения "iss" в ответе на авторизацию (например, утверждение "iss" в токене идентификации в OpenID).
4. Когда другие варианты противодействия для клиентов OAuth, взаимодействующих с несколькими серверами авторизации, отсутствуют, клиенты могут вместо этого использовать отдельные URI перенаправления для идентификации конечных точек авторизации и токенов.
5. Сервер авторизации позволяет избежать случайной пересылки или перенаправления запроса, потенциально содержащего учетные данные пользователя.

## Защищенный от PKCE ключ для механизма обмена кодами

Общедоступные клиенты OAuth 2.0, использующие предоставление кода авторизации, подвержены атаке на перехват кода авторизации. Защитный ключ для обмена кодами (PKCE, произносится как "pixy") - это метод, используемый для предотвращения угрозы атаки на перехват кода авторизации.

Первоначально PKCE предназначался исключительно для обеспечения безопасности собственных приложений, но затем он стал развернутой функцией OAuth. Он не только защищает от атак с использованием кода авторизации, но и защищает коды авторизации, созданные для общедоступных клиентов, поскольку PKCE гарантирует, что злоумышленник не сможет восстановить украденный код авторизации на конечной точке токена сервера авторизации без знания code_verifier.

6. Клиенты предотвращают внедрение (повторное использование) кодов авторизации в ответ на авторизацию с помощью потока PKCE. Кроме того, клиенты могут использовать параметр OpenID Connect "nonce" и соответствующее утверждение в токене ID вместо этого. Запрос PKCE или OpenID Connect "одноразовый" должен быть привязан к конкретной транзакции и надежно привязан к клиенту и пользовательскому агенту, в которых была запущена транзакция.
7. При использовании PKCE клиенты должны использовать методы проверки кода PKCE, которые не предоставляют средства проверки PKCE в запросе на авторизацию. В противном случае злоумышленники, которые могут прочитать запрос на авторизацию, могут нарушить безопасность, обеспечиваемую PKCE. Серверы авторизации должны поддерживать PKCE.
8. Если Клиент отправляет действительный параметр PKCE "code_challenge" в запросе на авторизацию, сервер авторизации обеспечивает правильное использование "code_verifier" в конечной точке токена.
9. Серверы авторизации предотвращают атаки с понижением рейтинга PKCE, гарантируя, что запрос токена, содержащий параметр "code_verifier", принимается только в том случае, если в запросе авторизации присутствует параметр "code_challenge".

## Неявное разрешение

Неявное разрешение - это упрощенный код авторизации, оптимизированный для клиентов, реализованный в браузере с использованием языка сценариев, такого как JavaScript. В неявном потоке вместо выдачи клиенту кода авторизации клиенту напрямую выдается токен доступа (в результате авторизации владельца ресурса). Тип предоставления является неявным, поскольку никакие промежуточные учетные данные (такие как код авторизации) не выдаются (и впоследствии не используются для получения токена доступа).

10. Клиенты используют тип ответа "код" (он же тип предоставления кода авторизации) или любой другой тип ответа, который заставляет сервер авторизации выдавать токены доступа в ответе на токен, например, тип ответа "код id_token". Это позволяет серверу авторизации обнаруживать попытки повторного воспроизведения со стороны злоумышленников и, как правило, уменьшает вероятность атаки, поскольку токены доступа не отображаются в URL-адресах. Это также позволяет серверу авторизации ограничивать отправку выданных токенов.

## Предотвращение воспроизведения токенов

11. Серверы авторизации и ресурсов используют механизмы для ограничения доступа отправителей к токенам для предотвращения повторения токенов, такие как Mutual TLS для OAuth 2.0 или OAuth Demonstration of Proof of Possession (DPoP).
12. Токены обновления ограничены отправителем или используйте ротацию токенов обновления.

## Ограничение привилегий токена доступа

13. Привилегии, связанные с токеном доступа, должны быть ограничены минимумом, требуемым для конкретного приложения или варианта использования. Это не позволяет клиентам превышать привилегии, разрешенные владельцем ресурса. Это также не позволяет пользователям превышать свои привилегии, разрешенные соответствующей политикой безопасности. Ограничения привилегий также помогают уменьшить последствия утечки токенов доступа.
14. Токены доступа ограничены определенными серверами ресурсов (ограничение аудитории), предпочтительно одним сервером ресурсов. Сервер авторизации должен связать токен доступа с определенными Серверами ресурсов, и каждый Сервер ресурсов обязан проверять для каждого запроса, предназначался ли токен доступа, отправленный с этим запросом, для использования на этом конкретном сервере ресурсов. Если нет, Сервер ресурсов должен отказать в обслуживании соответствующего запроса. Клиенты и серверы авторизации могут использовать параметры "область действия" и "ресурс" соответственно для определения сервера ресурсов, к которому они хотят получить доступ.
15. Токены доступа ограничены определенными ресурсами и действиями на серверах ресурсов или ресурсных ресурсах. Сервер авторизации должен связать токен доступа с соответствующим ресурсом и действиями, и каждый сервер ресурсов обязан проверять для каждого запроса, предназначался ли токен доступа, отправленный с этим запросом, для использования для этого конкретного действия на конкретном ресурсе. В противном случае сервер ресурсов должен отказаться обслуживать соответствующий запрос. Клиенты и серверы авторизации могут использовать параметры "область действия" и "authorization_details" для определения этих ресурсов и/или действий.

## Предоставление учетных данных с паролем владельцу ресурса

16. Предоставление учетных данных с паролем владельца ресурса не используется. Этот тип предоставления небезопасно предоставляет клиенту учетные данные владельца ресурса, увеличивая вероятность атаки приложения.

## Аутентификация клиента

17. Серверы авторизации по возможности используют аутентификацию клиента. Рекомендуется использовать асимметричные методы (основанные на открытом ключе) для аутентификации клиента, такие как motels или "private_key_jwt" (OpenID Connect). При использовании асимметричных методов аутентификации клиентов серверам авторизации не нужно хранить конфиденциальные симметричные ключи, что делает эти методы более устойчивыми к нескольким атакам.

## Другие рекомендации

18. Серверы авторизации не позволяют клиентам влиять на свои значения "client_id" или "sub", а также на любые другие утверждения, которые могут быть перепутаны с подлинным владельцем ресурса. Рекомендуется использовать сквозной протокол TLS.
19. Ответы на авторизацию не передаются по незашифрованным сетевым соединениям. Серверы авторизации не должны разрешать перенаправлять URI, использующие схему "http", за исключением собственных клиентов, которые используют обратное перенаправление интерфейса.

# Ссылки:

- [RFC 6750](https://www.rfc-editor.org/info/rfc6750)
- [RFC 6749](https://www.rfc-editor.org/info/rfc6749)
- [OAuth 2.0 Best Practices](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics#name-best-practices)
- [Mix-up attacks](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics-18#mix_up)
- [RFC9207](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics-18#section-2.1-4)
- [Other Countermeasures for Mix-up attacks](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics-18#section-2.1-6)
